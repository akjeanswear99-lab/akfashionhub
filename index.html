<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>AK FASHION HUB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ---------------- Basic layout ---------------- */
    :root { --brand:#000; --muted:#f4f4f4; --accent:#007bff; }
    body{ margin:0; font-family:Arial, sans-serif; background:var(--muted); color:#333; }
    header{
      background: linear-gradient(135deg, #000000, #1a1a1a);
      color:#fff; padding:28px 20px 24px; text-align:center; position:relative; border-bottom:1px solid rgba(255,255,255,0.08);
    }
    header h1{ margin:0; font-size:28px; letter-spacing:2px; font-weight:700; }
    header .tagline{ margin:8px 0 4px; font-size:13px; letter-spacing:1.2px; font-weight:500; opacity:0.85; }
    header .address{ margin:0; font-size:12px; letter-spacing:0.8px; opacity:0.7; }

    /* container + products */
    .container{ max-width:1200px; margin:auto; padding:20px; box-sizing:border-box; }
    .products{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:18px; }
    .card{ background:#fff; border-radius:8px; padding:15px; box-shadow:0 4px 8px rgba(0,0,0,0.08); }
    .card img{ width:100%; height:320px; object-fit:contain; border-radius:6px; background:#f7f7f7; }
    .product-img{ width:100%; max-height:500px; object-fit:contain; display:block; cursor:pointer; }

    /* selects & buttons */
    select, input, textarea, button{ width:100%; padding:8px; margin-top:6px; box-sizing:border-box; font-size:14px; }
    button{ background:var(--brand); color:#fff; border:none; cursor:pointer; border-radius:6px; padding:10px; }
    button:disabled{ background:gray; cursor:not-allowed; }

    /* cart panel */
    #cartPanel{ position:fixed; top:0; right:-360px; width:360px; height:100%; background:#fff; padding:20px; box-shadow:-6px 0 18px rgba(0,0,0,0.18); transition:0.28s right ease; z-index:10002; overflow:auto; }
    #cartOverlay{ position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); z-index:10001; display:none; }

    /* bottom cart bar for mobile */
    #bottomCartBar{ position:fixed; bottom:0; left:0; width:100%; background:#000; color:#fff; padding:12px; display:none; justify-content:space-between; align-items:center; z-index:9999; cursor:pointer; }

    /* toast & center alert */
    #toast{ position: fixed; top: 20px; right: 20px; background: #000; color: #fff; padding: 12px 18px; border-radius: 6px; font-size: 14px; opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; z-index: 10000; pointer-events: none; }
    #toast.show{ opacity: 1; transform: translateY(0); pointer-events: auto; }

    #centerAlert{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:20000; background: rgba(0,0,0,0.4); }
    #centerAlert .box{ background:#fff; padding:18px; border-radius:8px; max-width:90%; width:360px; text-align:center; box-shadow:0 8px 30px rgba(0,0,0,0.3); }
    #centerAlert .box p{ margin:0 0 12px 0; font-weight:600; }

    /* confirm remove box */
    #confirmBox{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:10000; }
    #confirmBox .inner{ background:#fff; padding:20px; width:90%; max-width:320px; border-radius:8px; text-align:center; }

    /* terms scroll */
    .terms-scroll{ max-height:60vh; overflow:auto; -webkit-overflow-scrolling: touch; }

    /* small utilities */
    .menu-icon{ position:absolute; top:22px; right:20px; cursor:pointer; z-index:10001; }
    .menu-icon span{ display:block; width:26px; height:3px; background:#fff; margin:5px 0; border-radius:3px; }
    .muted{ color:#777; font-size:13px; }
    .faded{ opacity:0.45; }

    /* footer full width fix: make footer full-bleed */
    footer{ background:#000; color:#fff; text-align:center; padding:15px; margin-top:40px; width:100vw; position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw; box-sizing:border-box; }
    footer a{ color:#fff; text-decoration:none; font-weight:600; }

    /* disabled option look (works across browsers mostly) */
    select option[disabled] { color:#999; }

    /* responsive tweaks */
    @media (max-width:768px){
      #cartPanel{ width:100%; right:-100%; }
    }
  </style>
</head>
<body>
  <!-- overlay + toast + center alert -->
  <div id="cartOverlay" onclick="toggleCart()"></div>
  <div id="toast" aria-live="polite"></div>

  <header style="position:relative;">
    <h1>AK FASHION HUB</h1>
    <div class="tagline">PREMIUM MEN & WOMEN FASHION WEAR</div>
    <div class="address">ADDRESS:- KESHAV NAGAR, SWARG AASHRAM ROAD, HAPUR 245101</div>

    <!-- cart open icon (left) -->
    <div onclick="toggleCart()" style="position:absolute; top:22px; left:20px; cursor:pointer; font-size:20px; z-index:10002;" aria-label="Open cart">
      üõí
    </div>

    <!-- menu icon (right) -->
    <div class="menu-icon" onclick="toggleCart()" aria-label="Open menu">
      <span></span><span></span><span></span>
    </div>
  </header>

  <!-- CART PANEL -->
  <div id="cartPanel" aria-hidden="true">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>Your Cart</h3>
      <span onclick="toggleCart()" style="cursor:pointer;font-size:22px;" aria-label="Close cart">‚úñ</span>
    </div>

    <div id="cartItems"></div>
    <h3 id="total"></h3>

    <div id="checkoutSection">
      <h4>Checkout</h4>
      <input id="name" placeholder="Name" aria-label="Customer name">
      <input id="phone" placeholder="10 digit mobile number" maxlength="10" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'')" aria-label="Phone number"/>
      <textarea id="address" placeholder="House / Shop No, Street / Area, Landmark, City, State - Pincode" rows="4"></textarea>
      <textarea id="note" placeholder="Order Note (Optional)"></textarea>

      <div style="margin-top:10px; font-size:14px;">
        <input type="checkbox" id="terms" style="width:auto;">
        I agree to
        <span style="color:var(--accent); cursor:pointer; text-decoration:underline;" onclick="openTermsFromCart()">
          Terms & Conditions
        </span>
      </div>
      <button id="placeOrderBtn" onclick="checkout()" style="margin-top:10px;">
        Place Order (WhatsApp)
      </button>

      <div id="myOrdersSection" style="display:none; margin-top:12px;">
        <!-- Back to checkout button injected dynamically if not present -->
        <input id="orderPhone" placeholder="Enter phone number" maxlength="10" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <input id="orderIdCheck" placeholder="Enter Order ID">
        <button onclick="showMyOrders()">VIEW ORDERS</button>
        <div id="myOrders" style="margin-top:10px;"></div>
      </div>

      <button onclick="openMyOrders()" style="margin-top:12px; background:#fff; color:#000; border:1px solid #000; font-weight:bold; letter-spacing:1px;">
        MY ORDERS
      </button>

      <hr>
    </div>
  </div>

  <!-- confirm remove box -->
  <div id="confirmBox">
    <div class="inner">
      <p id="confirmText" style="margin-bottom:15px;font-weight:bold;"></p>
      <div style="display:flex; gap:8px;">
        <button onclick="confirmYes()" style="flex:1;">OK</button>
        <button onclick="confirmNo()" style="flex:1; background:#ccc; color:#000;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- center alert (used for out-of-stock) -->
  <div id="centerAlert" role="alert" aria-live="assertive">
    <div class="box">
      <p id="centerAlertText">Out of stock</p>
      <button onclick="hideCenterAlert()" style="padding:8px 12px; background:#000; color:#fff; border:none; border-radius:4px;">OK</button>
    </div>
  </div>

  <!-- Floating WhatsApp CTA -->
  <a href="https://wa.me/919599497909" target="_blank" rel="noopener noreferrer" style="position:fixed; bottom:20px; right:20px; background:#25D366; color:white; padding:14px 20px; border-radius:30px; text-decoration:none; font-weight:bold; font-size:15px; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:9999; display:flex; align-items:center; gap:8px;">
    üí¨ Chat Now
  </a>

  <div class="container">
    <h2>Products</h2>
    <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
      <button onclick="filterProducts('All')" aria-pressed="true">All</button>
      <button onclick="filterProducts('Men')">Men</button>
      <button onclick="filterProducts('Women')">Women</button>
    </div>

    <div class="products" id="products"></div>
  </div>

  <footer>
    <p>Return Policy: <span style="color:#4da3ff; cursor:pointer; text-decoration:underline;" onclick="openTerms()">(Terms and Conditions Apply)</span></p>
    <p style="margin-bottom:10px; font-size:14px;"><b>Follow us on</b></p>
    <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
      <a href="https://www.instagram.com/a_k_fashion_hub_/" target="_blank" rel="noopener noreferrer" style="background:#E1306C; color:#fff; padding:10px 18px; border-radius:25px; text-decoration:none; font-size:14px; font-weight:bold;">
        Instagram
      </a>
      <a href="https://share.google/1K75n4058QJ60W7RZ" target="_blank" rel="noopener noreferrer" style="background:#4285F4; color:#fff; padding:10px 18px; border-radius:25px; text-decoration:none; font-size:14px; font-weight:bold;">
        Google Review
      </a>
    </div>
  </footer>

  <div id="bottomCartBar" onclick="toggleCart()"></div>

  <script>
    /* ---------------- Constants: replace these URLs with your actual Google Apps Script endpoints ---------------- */
    const CHECK_STOCK_URL = "https://script.google.com/macros/s/AKfycbzlZcI0BxlKW_Q_L2XUx7AYPrMqYSTjdj2uHDTS3CLunsmXFuZm04Rb7SsCFVXB7Rn4/exec";
    const ORDER_SHEET_URL = "https://script.google.com/macros/s/AKfycbwMWrEhaO4sGqHhUX7nr-zrCtROhYx0krL2Cx6rVbA0pMCenDGP32xDWMrcQb9KgaLi/exec";
    // Replace with your update stock endpoint (or extend your CHECK_STOCK handler to support UPDATE_STOCK)
    const UPDATE_STOCK_URL = "https://script.google.com/macros/s/YOUR_UPDATE_STOCK_SCRIPT_ID/exec";

    /* ---------------- Dummy images (base64 tiny placeholders) ---------------- */
    const img1 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";
    const img2 = img1;
    const img3 = img1;
    const img4 = img1;

    /* ---------------- Products data (with inventory object) ----------------
       Note: inventory is a nested object: inventory[size][color] = stockCount
       Keep expanding sizes/colors as you like. For server sync, maintain same mapping on Google Sheet.
    ---------------------------------------------------------------------- */
    const products = [
      {
        id:"AKJ001",
        gender:"Men",
        name:"Blue Denim Jeans",
        category:"Jeans",
        price:1999,
        discount:20,
        img:[img1],
        colors:["Blue","Black"],
        sizes:["28","30","32","34","36"],
        measure:"Waist, Length, Thigh",
        inventory: {
          "28": { "Black": 5, "Blue": 5 },
          "30": { "Black": 5, "Blue": 5 },
          "32": { "Black": 5, "Blue": 5 },
          "34": { "Black": 5, "Blue": 5 },
          "36": { "Black": 5, "Blue": 5 }
        }
      },
      {
        id:"AKL002",
        gender:"Men",
        name:"Black Lower",
        category:"Lower",
        price:1499,
        discount:15,
        img:[img3, img4],
        colors:["Black","Gray"],
        sizes:["S","M","L","XL"],
        measure:"Waist, Length, Thigh",
        inventory:{
          "S": { "Black": 5, "Gray": 5 },
          "M": { "Black": 5, "Gray": 5 },
          "L": { "Black": 5, "Gray": 5 },
          "XL": { "Black": 5, "Gray": 5 }
        }
      },
      {
        id:"AKT003",
        gender:"Men",
        name:"Cotton T-Shirt",
        category:"T-Shirt",
        price:999,
        discount:30,
        img:[img2, img3],
        colors:["Red","White","Black"],
        sizes:["S","M","L","XL","XXL"],
        measure:"Chest, Waist, Shoulder",
        inventory:{
          "S": { "Red": 5, "White": 5, "Black":5 },
          "M": { "Red": 5, "White": 5, "Black":5 },
          "L": { "Red": 5, "White": 5, "Black":5 },
          "XL": { "Red": 5, "White": 5, "Black":5 },
          "XXL": { "Red": 5, "White": 5, "Black":5 }
        }
      },
      {
        id:"AKS004",
        gender:"Men",
        name:"Formal Shirt",
        category:"Shirt",
        price:1299,
        discount:25,
        img:[img4, img1],
        colors:["White","Blue"],
        sizes:["M","L","XL"],
        measure:"Chest, Waist, Shoulder",
        inventory:{
          "M": { "White": 5, "Blue": 5 },
          "L": { "White": 5, "Blue": 5 },
          "XL": { "White": 5, "Blue": 5 }
        }
      },
      {
        id:"AKK005",
        gender:"Women",
        name:"Embroidered Kurti",
        category:"Kurti",
        price:1799,
        discount:20,
        img:[img3, img2],
        colors:["Pink","Green"],
        sizes:["XS","S","M","L","XL","XXL"],
        measure:"Chest, Waist, Shoulder, Length",
        inventory:{
          "XS": { "Pink": 5, "Green": 5 },
          "S": { "Pink": 5, "Green": 5 },
          "M": { "Pink": 5, "Green": 5 },
          "L": { "Pink": 5, "Green": 5 },
          "XL": { "Pink": 5, "Green": 5 },
          "XXL": { "Pink": 5, "Green": 5 }
        }
      },
      {
        id: "AKF006",
        gender: "Women",
        name: "Slim Fit Female Jeans",
        category: "Jeans",
        price: 1699,
        discount: 15,
        img: [img1, img2],
        colors: ["Blue","Black"],
        sizes: ["28","29","30","31","32","33","34"],
        measure: "Waist, Length, Thigh",
        inventory: {
          "28": { "Blue": 5, "Black": 5 },
          "29": { "Blue": 5, "Black": 5 },
          "30": { "Blue": 5, "Black": 5 },
          "31": { "Blue": 5, "Black": 5 },
          "32": { "Blue": 5, "Black": 5 },
          "33": { "Blue": 5, "Black": 5 },
          "34": { "Blue": 5, "Black": 5 }
        }
      }
    ];

    /* ---------------- Local cart + state ---------------- */
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let currentFilter = "All";

    /* ---------------- Utilities: Toast & CenterAlert ---------------- */
    function showToast(message, ms = 2000){
      const toast = document.getElementById("toast");
      toast.innerText = message;
      toast.classList.add("show");
      setTimeout(()=>{ toast.classList.remove("show"); }, ms);
    }
    function showCenterAlert(message){
      document.getElementById("centerAlertText").innerText = message;
      document.getElementById("centerAlert").style.display = "flex";
    }
    function hideCenterAlert(){ document.getElementById("centerAlert").style.display = "none"; }

    /* ---------------- Filter & Render Products ---------------- */
    function filterProducts(type){
      currentFilter = type;
      renderProducts();
    }

    function renderProducts(){
      const box=document.getElementById("products");
      box.innerHTML="";
      products.forEach((p,i)=>{
        if(currentFilter !== "All" && p.gender !== currentFilter) return;
        const final=Math.round(p.price-(p.price*p.discount/100));
        const imageSrc = p.img && p.img.length ? p.img[0] : img1;

        // Build size options with disabled flag if ALL colors are out of stock for that size
        const sizeOptions = p.sizes.map(s=>{
          const invForSize = p.inventory && p.inventory[s];
          let anyAvailable = false;
          if(invForSize){
            for(const c of p.colors){
              if((invForSize[c] || 0) > 0){ anyAvailable = true; break; }
            }
          }
          return `<option value="${s}" ${anyAvailable ? "" : "disabled"}>${s}${anyAvailable ? "" : " (Out)"}</option>`;
        }).join("");

        // Color options: placeholder + all colors (disabled set later when size selected)
        const colorOptions = ['<option value="">Select Color</option>'].concat(p.colors.map(c=>`<option value="${c}">${c}</option>`)).join("");

        box.innerHTML+=`
          <div class="card" data-index="${i}">
            <div class="slider">
              <img src="${imageSrc}" id="img${i}" class="product-img" onclick="openImage('${imageSrc}')">
            </div>
            <p style="font-size:12px; font-weight:bold; color:#555;">
              ${p.gender === "Men" ? "Men‚Äôs Product" : "Women‚Äôs Product"}
            </p>
            <h3>${p.name}</h3>
            <p>SKU: ${p.id}</p>
            <p>${p.category}</p>
            <p>MRP ‚Çπ${p.price} | ${p.discount}% OFF</p>
            <p><b>‚Çπ${final}</b></p>
            <p>Measurements: ${p.measure}</p>

            <select id="size${i}" onchange="updateStockMsg(${i})">
              <option value="">Select Size</option>
              ${sizeOptions}
            </select>

            <select id="color${i}" onchange="updateStockMsg(${i})">
              ${colorOptions}
            </select>

            <p id="stockMsg${i}" style="font-size:12px;font-weight:bold;"></p>
            <button id="btn${i}" disabled onclick="addToCart(${i})" aria-label="Add ${p.name} to cart">
              Add to Cart
            </button>
          </div>`;
      });
      updateCartBadge();
    }

    /* ---------------- Update stock message & enable/disable color options ---------------- */
    function updateStockMsg(i){
      const sizeEl = document.getElementById("size"+i);
      const colorEl = document.getElementById("color"+i);
      const size = sizeEl ? sizeEl.value : "";
      const color = colorEl ? colorEl.value : "";
      const msg = document.getElementById("stockMsg"+i);
      const btn = document.getElementById("btn"+i);
      const p = products[i];

      // If size selected -> disable color options with zero stock for that size
      if(size && colorEl){
        Array.from(colorEl.options).forEach(opt=>{
          if(opt.value === "") return;
          const col = opt.value;
          const stock = (p.inventory && p.inventory[size]) ? (p.inventory[size][col] || 0) : 0;
          if(stock <= 0){
            opt.disabled = true;
            opt.text = col + " (Out)";
            opt.style.opacity = 0.5;
          } else {
            opt.disabled = false;
            opt.text = col;
            opt.style.opacity = 1;
          }
        });
      } else if(colorEl){
        // reset color options if no size chosen
        Array.from(colorEl.options).forEach(opt=>{
          if(opt.value === "") return;
          const col = opt.value;
          opt.disabled = false;
          opt.text = col;
          opt.style.opacity = 1;
        });
      }

      // Show availability only when both selected
      if(!size || !color){
        msg.innerText = "";
        btn.disabled = true;
        return;
      }
      const stock = (p.inventory && p.inventory[size]) ? (p.inventory[size][color] || 0) : 0;

      if(stock > 0){
        msg.innerText = `Available: ${stock}`;
        msg.style.color = "blue";
        btn.disabled = false;
      } else {
        msg.innerText = "Out of stock";
        msg.style.color = "red";
        btn.disabled = true;
      }
    }

    /* ---------------- Add to cart ---------------- */
    function addToCart(i){
      const size = document.getElementById("size"+i).value;
      const color = document.getElementById("color"+i).value;
      if(!size || !color){
        showToast("Select size & color");
        return;
      }
      const p = products[i];
      const maxStock = (p.inventory && p.inventory[size]) ? (p.inventory[size][color] || 0) : 0;
      if(maxStock <= 0){ showCenterAlert("This item is currently out of stock."); return; }

      let existing = cart.find(item => item.id === p.id && item.size === size && item.color === color);
      if(existing){
        if(existing.qty < existing.maxStock){
          existing.qty++;
        }else{
          showCenterAlert("Maximum stock limit reached");
          return;
        }
      }else{
        cart.push({
          id: p.id,
          name: p.name,
          price: p.price,
          discount: p.discount,
          size,
          color,
          qty: 1,
          maxStock: maxStock
        });
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      updateCart();
      showToast("Item added to cart successfully");
      toggleCart();
    }

    /* ---------------- Cart UI + change qty + remove ---------------- */
    function updateCart(){
      let total = 0;
      const box = document.getElementById("cartItems");
      box.innerHTML = "";
      cart.forEach((c, index)=>{
        const price = Math.round(c.price - (c.price * c.discount / 100));
        total += price * c.qty;

        box.innerHTML += `
          <div style="border-bottom:1px solid #eee; padding:10px 0; margin-bottom:10px;">
            <b>${c.name}</b><br>
            Size: ${c.size} | Color: ${c.color}<br>
            Qty:
            <button onclick="changeQty(${index}, -1)" aria-label="Decrease quantity">‚àí</button>
            <b style="margin:0 8px;">${c.qty}</b>
            <button onclick="changeQty(${index}, 1)" aria-label="Increase quantity">+</button><br>
            Amount: ‚Çπ${price * c.qty}<br><br>
            <button style="background:red;" onclick="askRemove(${index})">Remove Item</button>
          </div>
        `;
      });

      document.getElementById("total").innerText = "Total: ‚Çπ" + total;
      updateCartBadge();
      updateBottomBar(total);
    }

    function changeQty(index, diff){
      const item = cart[index];
      if(diff === -1){
        item.qty--;
        if(item.qty <= 0){
          cart.splice(index,1);
        }
      }
      if(diff === 1){
        if(item.qty < item.maxStock){
          item.qty++;
        }else{
          showCenterAlert("Maximum stock limit reached");
          return;
        }
      }
      localStorage.setItem("cart", JSON.stringify(cart));
      updateCart();
    }

    let removeIndex = null;
    function askRemove(index){
      removeIndex = index;
      const item = cart[index];
      document.getElementById("confirmText").innerText = `Are you sure you want to remove "${item.name}" from cart?`;
      document.getElementById("confirmBox").style.display = "flex";
    }
    function confirmYes(){
      cart.splice(removeIndex, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      document.getElementById("confirmBox").style.display = "none";
      showToast("Item removed from cart");
      updateCart();
      renderProducts();
    }
    function confirmNo(){ document.getElementById("confirmBox").style.display = "none"; }

    /* ---------------- Order ID generation ---------------- */
    function generateOrderId(){
      const now = new Date();
      const date = now.getFullYear().toString() + String(now.getMonth() + 1).padStart(2, "0") + String(now.getDate()).padStart(2, "0");
      const random = Math.floor(1000 + Math.random() * 9000);
      return `AKFH-${date}-${random}`;
    }

    /* ---------------- Checkout: verify fields, server-side stock check, save order, update stock ---------------- */
    async function checkout(){
      const termsAccepted = document.getElementById("terms").checked;
      if(!termsAccepted){ alert("Please accept Terms & Conditions to place order"); return; }

      const n = document.getElementById("name").value.trim();
      const p = document.getElementById("phone").value.trim();
      if(p.length !== 10){ alert("Enter valid 10 digit mobile number"); return; }
      const a = document.getElementById("address").value.trim();
      if(a.length < 20){ alert("Please enter complete address with landmark, city, state & pincode"); return; }
      const note = document.getElementById("note").value.trim();

      if(!n || !p || !a || cart.length === 0){ showToast("Fill all details and add items to cart"); return; }

      // Server-side stock check for each item
      for (let item of cart) {
        try {
          const response = await fetch(CHECK_STOCK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "CHECK_STOCK", sku: item.id, size: item.size, color: item.color })
          });
          const result = await response.json();
          if (!result.allowed) {
            showCenterAlert(`${item.name} (${item.size}, ${item.color}) is OUT OF STOCK`);
            return;
          }
        } catch (err) {
          alert("Unable to verify stock at this time. Please try again.");
          return;
        }
      }

      const orderId = generateOrderId();
      let totalQty = 0;
      cart.forEach(c => totalQty += c.qty);
      let totalAmount = 0;
      cart.forEach(c => { const price = Math.round(c.price - (c.price * c.discount / 100)); totalAmount += price * c.qty; });

      // Save order locally by phone (for My Orders)
      let allOrders = JSON.parse(localStorage.getItem("ordersByPhone")) || {};
      if (!allOrders[p]) allOrders[p] = [];
      allOrders[p].push({
        orderId: orderId,
        date: new Date().toLocaleString(),
        items: cart.map(c => ({ name: c.name, size: c.size, color: c.color, qty: c.qty })),
        total: totalAmount,
        status: "Order Received"
      });
      localStorage.setItem("ordersByPhone", JSON.stringify(allOrders));

      // Send order to Google Sheet (best-effort; don't block if fails)
      fetch(ORDER_SHEET_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orderId: orderId,
          name: n,
          phone: p,
          address: a,
          products: cart.map(c => `${c.name} | SKU:${c.id} | Size:${c.size} | Color:${c.color} | Qty:${c.qty}`).join(" || "),
          totalQty: totalQty,
          totalAmount: totalAmount
        })
      }).catch(()=>{/* ignore sheet errors here to avoid blocking user */});

      // Update server + local inventory
      await decrementStockForOrder(cart);

      // Build WhatsApp message & open
      let msg = `AK FASHION HUB\nOrder ID: ${orderId}\nKeshav Nagar, Hapur 245101\n\n`;
      cart.forEach(c=>{
        const price = Math.round(c.price - (c.price * c.discount / 100));
        msg += `${c.name}\nSKU:${c.id}\nSize:${c.size}\nColor:${c.color}\n‚Çπ${price}\nQty: ${c.qty}\n\n`;
      });
      msg += `Customer: ${n}\nPhone: ${p}\nAddress: ${a}\nNote: ${note}`;

      window.open("https://wa.me/919599497909?text=" + encodeURIComponent(msg));

      alert("Order Placed Successfully!\nYour Order ID: " + orderId);

      // clear cart & UI
      cart = [];
      localStorage.removeItem("cart");
      updateCart();
      renderProducts();
    }

    /* ---------------- Decrement stock locally + call server to update sheet ----------------
       NOTE: Replace UPDATE_STOCK_URL with your Apps Script URL that handles action: "UPDATE_STOCK"
       The handler should accept { action: "UPDATE_STOCK", sku, size, color, qty } and subtract qty from sheet.
    ------------------------------------------------------------------------------ */
    async function decrementStockForOrder(orderCart){
      for(const item of orderCart){
        // 1) Update local products inventory
        const prod = products.find(p=>p.id === item.id);
        if(prod && prod.inventory && prod.inventory[item.size] && typeof prod.inventory[item.size][item.color] !== 'undefined'){
          prod.inventory[item.size][item.color] = Math.max(0, prod.inventory[item.size][item.color] - item.qty);
        }

        // 2) Call server to subtract stock
        try{
          await fetch(UPDATE_STOCK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "UPDATE_STOCK",
              sku: item.id,
              size: item.size,
              color: item.color,
              qty: item.qty  // subtract this amount
            })
          });
        }catch(e){
          console.error("Failed to update server stock for", item, e);
        }
      }
      renderProducts();
      showToast("Stock updated.");
    }

    /* ---------------- Cart badge + bottom bar ---------------- */
    function updateCartBadge(){
      let badge = document.getElementById("cartCount");
      if(!badge){
        const cartIcon = document.querySelector('[onclick="toggleCart()"]');
        badge = document.createElement("span");
        badge.id = "cartCount";
        badge.style.background = "red";
        badge.style.color = "white";
        badge.style.borderRadius = "50%";
        badge.style.padding = "2px 6px";
        badge.style.fontSize = "12px";
        badge.style.marginLeft = "6px";
        cartIcon.appendChild(badge);
      }
      let totalQty = 0;
      cart.forEach(i => totalQty += i.qty);
      badge.innerText = totalQty;
      // mobile bottom bar
      const total = cart.reduce((s,i)=>s + Math.round(i.price - (i.price*i.discount/100)) * i.qty, 0);
      updateBottomBar(total);
    }
    function updateBottomBar(total){
      let bar = document.getElementById("bottomCartBar");
      if(!bar){
        bar = document.createElement("div");
        bar.id = "bottomCartBar";
        bar.style.position = "fixed";
        bar.style.bottom = "0";
        bar.style.left = "0";
        bar.style.width = "100%";
        bar.style.background = "#000";
        bar.style.color = "#fff";
        bar.style.padding = "12px";
        bar.style.display = "none";
        bar.style.justifyContent = "space-between";
        bar.style.alignItems = "center";
        bar.style.zIndex = "9999";
        bar.onclick = toggleCart;
        document.body.appendChild(bar);
      }
      if(window.innerWidth < 768 && cart.length > 0){
        bar.style.display = "flex";
        bar.innerHTML = `üõí View Cart (${cart.reduce((s,i)=>s+i.qty,0)}) <b>‚Çπ${total}</b>`;
      }else{
        bar.style.display = "none";
      }
    }

    /* ---------------- Toggle cart ---------------- */
    function toggleCart(){
      const cartPanel = document.getElementById("cartPanel");
      const overlay = document.getElementById("cartOverlay");
      if(window.getComputedStyle(cartPanel).right === "0px" || cartPanel.style.right === "0px"){
        cartPanel.style.right = window.innerWidth < 768 ? "-100%" : "-360px";
        overlay.style.display = "none";
        cartPanel.setAttribute('aria-hidden','true');
      }else{
        cartPanel.style.right = "0px";
        overlay.style.display = "block";
        cartPanel.setAttribute('aria-hidden','false');
      }
    }

    /* ---------------- Image modal (zoom & dblclick) ---------------- */
    function openImage(src){
      let modal = document.createElement("div");
      modal.style.position = "fixed";
      modal.style.top = "0";
      modal.style.left = "0";
      modal.style.width = "100%";
      modal.style.height = "100%";
      modal.style.background = "rgba(0,0,0,0.9)";
      modal.style.zIndex = "9999";
      modal.style.display = "flex";
      modal.style.alignItems = "center";
      modal.style.justifyContent = "center";
      modal.style.overflow = "hidden";

      modal.innerHTML = `
        <div style="overflow:auto; max-width:100%; max-height:100%;">
          <img src="${src}" style="max-width:100%; max-height:100%; transform-origin:center center; cursor:zoom-in;" id="zoomImg">
        </div>
      `;

      let scale = 1;
      const img = modal.querySelector("#zoomImg");
      img.onwheel = (e) => {
        e.preventDefault();
        scale += e.deltaY * -0.001;
        scale = Math.min(Math.max(1, scale), 4);
        img.style.transform = `scale(${scale})`;
      };
      img.ondblclick = () => { scale = scale === 1 ? 2 : 1; img.style.transform = `scale(${scale})`; };
      modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
      document.body.appendChild(modal);
    }

    /* ---------------- Terms modal (standalone & in-cart scroll-to-enable) ---------------- */
    function openTerms(){
      let modal = document.createElement("div");
      modal.style.position="fixed"; modal.style.top="0"; modal.style.left="0"; modal.style.width="100%"; modal.style.height="100%"; modal.style.background="rgba(0,0,0,0.8)"; modal.style.zIndex="9999"; modal.style.display="flex"; modal.style.alignItems="center"; modal.style.justifyContent="center";
      modal.innerHTML = `
        <div style="background:#fff; padding:20px; max-width:720px; max-height:85%; overflow:auto; border-radius:8px;">
          <h3>Terms & Conditions ‚Äì AK FASHION HUB</h3>
          <div class="terms-scroll" style="font-size:14px; line-height:1.6;">
            <!-- FULL TERMS TEXT -->
            ‚Ä¢ <b>Delivery Time:</b> Orders will be delivered within <b>4‚Äì6 working days</b> after the order is confirmed. Delivery timelines may vary depending on location, courier partner, and operational conditions.<br><br>
            ‚Ä¢ <b>Cancellation & Refund (Before Dispatch):</b> Orders cancelled within <b>12 hours</b> of placing the order are eligible for a <b>full refund</b>. The refund amount will be processed and credited within <b>2‚Äì3 working days</b> after cancellation confirmation.<br><br>
            ‚Ä¢ <b>Cancellation Policy (After Dispatch):</b> Once the order has been <b>dispatched</b>, cancellation will <b>not be allowed</b>. In such cases, the customer is required to make <b>full payment</b> for the order.<br><br>
            ‚Ä¢ <b>Product Images Disclaimer:</b> All product images displayed on this website are captured using professional camera equipment or generated/enhanced using AI technology. Due to variations in screen resolution, lighting conditions, camera settings, and pixel density, there may be slight differences in color, texture, or appearance between the images shown and the actual product received.<br><br>
            ‚Ä¢ <b>Return & Replacement Request:</b> Any return or replacement request must be raised within <b>3 days</b> from the date of product delivery.<br><br>
            ‚Ä¢ <b>Mandatory Proof:</b> A <b>clear unboxing video</b> along with <b>clear photos</b> of the received product is mandatory for all return or replacement requests. Requests without proper video and photo proof will not be accepted under any circumstances.<br><br>
            ‚Ä¢ <b>Product Condition:</b> The product must be <b>unused, unwashed, undamaged, and in original condition</b>. Products that are worn, washed, dirty, altered, or damaged will not be eligible for return or replacement.<br><br>
            ‚Ä¢ <b>Invoice Requirement:</b> The <b>original invoice/bill</b> provided with the product must be submitted at the time of return or replacement. Requests without the original invoice will not be processed.<br><br>
            ‚Ä¢ <b>Refund Eligibility:</b> Refunds will be issued <b>only</b> in cases where an <b>incorrect or damaged product</b> has been delivered by AK FASHION HUB.<br><br>
            ‚Ä¢ <b>Size & Fit Issues:</b> In case of size or fitting issues, <b>only replacement will be provided</b>. Refunds are <b>not applicable</b> for size or fitting concerns.<br><br>
            ‚Ä¢ <b>Shipping Charges:</b> For size or fitting replacements, the customer is required to pay <b>one-side delivery/shipping charges</b>.<br><br>
            ‚Ä¢ <b>Color Variation Disclaimer:</b> Minor color differences may occur due to screen brightness, display settings, and lighting conditions. Such variations shall <b>not be considered a defect</b>.<br><br>
            ‚Ä¢ <b>Agreement:</b> By placing an order, the customer confirms that they have <b>read, understood, and agreed</b> to all the above Terms & Conditions.
          </div>
          <button id="agreeInlineBtn" style="width:100%; margin-top:10px;">I Agree</button>
        </div>
      `;
      modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
      document.body.appendChild(modal);
      document.getElementById('agreeInlineBtn').onclick = function(){ document.getElementById('terms').checked = true; modal.remove(); };
    }

    function openTermsFromCart(){
      const modal = document.createElement("div");
      modal.style.cssText = `position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:20000; display:flex; align-items:center; justify-content:center;`;
      modal.innerHTML = `
        <div style="background:#fff; width:90%; max-width:640px; max-height:80%; border-radius:8px; padding:15px; display:flex; flex-direction:column;">
          <h3 style="text-align:center;margin:0 0 8px;">Terms & Conditions ‚Äì AK FASHION HUB</h3>
          <div id="termsBox" class="terms-scroll" style="flex:1; overflow:auto; border:1px solid #ddd; padding:10px; font-size:14px; line-height:1.6;">
            <!-- same terms text -->
            ‚Ä¢ <b>Delivery Time:</b> Orders will be delivered within <b>4‚Äì6 working days</b> after the order is confirmed. ...
            <br><br>
            <!-- (text truncated in modal source for brevity) -->
          </div>
          <div id="scrollHint" style="font-size:12px;text-align:center;color:#666;">‚¨áÔ∏è Scroll down to enable</div>
          <button id="agreeBtn" disabled style="margin-top:10px; padding:10px; background:gray; color:#fff; border:none; border-radius:4px; cursor:not-allowed;">I Agree</button>
        </div>
      `;
      document.body.appendChild(modal);

      const box = modal.querySelector("#termsBox");
      const btn = modal.querySelector("#agreeBtn");
      const hint = modal.querySelector("#scrollHint");

      if(box.scrollHeight <= box.clientHeight + 2){
        btn.disabled = false; btn.style.background = "#000"; btn.style.cursor = "pointer"; hint.style.display = "none";
      }
      box.addEventListener("scroll", ()=>{
        if(box.scrollTop + box.clientHeight >= box.scrollHeight - 5){
          btn.disabled = false; btn.style.background = "#000"; btn.style.cursor = "pointer"; hint.style.display = "none";
        }
      });
      btn.onclick = ()=>{ document.getElementById("terms").checked = true; modal.remove(); };
      modal.onclick = e=>{ if(e.target === modal) modal.remove(); };
    }

    /* ---------------- My Orders: open + back + show ---------------- */
    function openMyOrders(){
      document.getElementById("checkoutSection").style.display = "none";
      document.getElementById("myOrdersSection").style.display = "block";
      if(!document.getElementById("backToCheckoutBtn")){
        const mySection = document.getElementById("myOrdersSection");
        const backBtn = document.createElement("button");
        backBtn.id = "backToCheckoutBtn";
        backBtn.textContent = "‚Üê Back to Checkout";
        backBtn.style.marginTop = "6px";
        backBtn.style.background = "#000";
        backBtn.style.color = "#fff";
        backBtn.onclick = backToCheckout;
        mySection.insertBefore(backBtn, mySection.firstChild);
      }
    }
    function backToCheckout(){
      document.getElementById("myOrdersSection").style.display = "none";
      document.getElementById("checkoutSection").style.display = "block";
    }

    function showMyOrders(){
      const phone = document.getElementById("orderPhone").value.trim();
      const orderIdInput = document.getElementById("orderIdCheck").value.trim();
      const box = document.getElementById("myOrders");
      const allOrders = JSON.parse(localStorage.getItem("ordersByPhone")) || {};
      const orders = allOrders[phone];

      if (!orders) {
        box.innerHTML = "<p>Invalid phone number or Order ID</p>";
        return;
      }

      const matched = orders.some(o => o.orderId === orderIdInput);
      if (!matched) {
        box.innerHTML = "<p>Invalid phone number or Order ID</p>";
        return;
      }

      let html = "";
      orders.forEach(o => {
        html += `
          <div style="border:1px solid #ddd; padding:8px; margin-bottom:8px;">
            <b>Order ID:</b> ${o.orderId}<br>
            <b>Date:</b> ${o.date}<br>
            <b>Status:</b> ${o.status}<br>
            <b>Total:</b> ‚Çπ${o.total}<br>
            <b>Items:</b><br>
            ${o.items.map(i => `‚Ä¢ ${i.name} (${i.size}, ${i.color}) √ó ${i.qty}`).join("<br>")}
          </div>
        `;
      });
      box.innerHTML = html;
    }

    /* ---------------- Note field word limit ---------------- */
    const noteField = document.getElementById("note");
    noteField.addEventListener("input", function () {
      const words = this.value.trim().split(/\s+/);
      if (words.length > 30) {
        this.value = words.slice(0, 30).join(" ");
      }
    });

    /* ---------------- Initial render + sync ---------------- */
    renderProducts();
    updateCart();
    updateCartBadge();

    /* ---------------- Persist cart on page load ---------------- */
    window.addEventListener("load", ()=>{
      cart = JSON.parse(localStorage.getItem('cart')) || [];
      updateCart();
      renderProducts();
    });

    /* ---------------- Accessibility: close modals on escape ---------------- */
    document.addEventListener('keydown', function(e){
      if(e.key === "Escape"){
        const modal = document.querySelector('[role="dialog"]');
        if(modal) modal.remove();
        hideCenterAlert();
        document.getElementById("confirmBox").style.display = "none";
      }
    });
  </script>
</body>
</html>
