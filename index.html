<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AK FASHION HUB</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>

    /* Basic Reset & Body */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html, body {
        width: 100%;
        background: #f4f4f4;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #333;
        overflow-x: hidden;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    body {
        padding-bottom: 70px;
    }

    input, textarea {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }

    /* Header */
    header {
        background: #000;
        color: #fff;
        padding: 25px 20px;
        text-align: center;
    }

    header h1 {
        font-size: 32px;
        letter-spacing: 3px;
        margin-bottom: 5px;
        font-weight: 900;
        text-transform: uppercase;
        background: linear-gradient(45deg, #ffffff, #aaaaaa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0px 2px 4px rgba(0,0,0,0.3);
    }

    header .tagline {
        font-size: 12px;
        opacity: 0.8;
        letter-spacing: 1px;
    }

    header .address {
        font-size: 10px;
        opacity: 0.6;
        margin-top: 5px;
    }

    /* Container */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Filters */
    .filter-bar {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 25px;
    }

    .filter-btn {
        padding: 8px 20px;
        background: #fff;
        border: 1px solid #000;
        color: #000;
        cursor: pointer;
        border-radius: 20px;
        font-weight: bold;
    }

    .filter-btn:hover, .filter-btn.active {
        background: #000;
        color: #fff;
    }

    /* Product Grid */
    .products {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 20px;
    }

    /* Product Card */
    .card {
        position: relative;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.3s;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .card img {
        width: 100%;
        height: 420px;
        object-fit: cover;
        display: block;
        background: #f9f9f9;
    }

    /* Price Overlay Inside Photo */
    .price-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(transparent, rgba(0,0,0,0.9));
        padding: 40px 15px 15px;
        color: #fff;
    }

    .price-overlay .mrp-tag {
        font-size: 13px;
        text-decoration: line-through;
        opacity: 0.7;
        display: block;
        margin-bottom: 2px;
    }

    .price-overlay .final-tag {
        font-size: 20px;
        font-weight: bold;
        display: block;
    }

    .price-overlay .name-tag {
        font-size: 14px;
        margin-top: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Modal (Product Popup) */
    #productModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        z-index: 9990;
        display: none;
        flex-direction: column;
        overflow-y: auto;
    }

    #productModal .top-bar {
        position: sticky;
        top: 0;
        background: #000;
        padding: 15px 20px;
        border-bottom: 1px solid #000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
    }

    #productModal .top-bar h3 {
        color: #fff;
    }

    #productModal .close-btn {
        font-size: 28px;
        cursor: pointer;
        font-weight: bold;
        color: #fff;
    }

    #productModal .content {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        padding-bottom: 80px;
        width: 100%;
    }

    /* Big Image in Modal */
    .main-image-box {
        width: 100%;
        background: #f9f9f9;
        border-radius: 8px;
        overflow: hidden;
        text-align: center;
        position: relative;
    }

    .main-image-box img {
        width: auto;
        max-width: 100%;
        max-height: 500px;
        object-fit: contain;
        cursor: zoom-in;
    }

    /* Thumbnails */
    .thumbs {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        justify-content: center;
        overflow-x: auto;
        padding-bottom: 10px;
    }

    .thumb {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        border: 2px solid transparent;
        cursor: pointer;
        opacity: 0.6;
        flex-shrink: 0;
    }

    .thumb.active, .thumb:hover {
        border-color: #000;
        opacity: 1;
    }

    /* Zoom Overlay */
    #zoomOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.95);
        z-index: 999999;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: zoom-out;
    }
    #zoomOverlay img {
        max-width: 95%;
        max-height: 95%;
        object-fit: contain;
    }

    /* Details Section */
    .details .price-big {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .details .desc {
        font-size: 14px;
        color: #555;
        line-height: 1.5;
        margin-bottom: 15px;
    }

    /* Options */
    .opt-group {
        margin-bottom: 15px;
    }

    .opt-title {
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 8px;
        color: #666;
    }

    .opt-box {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .opt-btn {
        padding: 8px 16px;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        background: #fff;
    }

    .opt-btn.selected {
        background: #000;
        color: #fff;
        border-color: #000;
    }

    /* Size Info Display */
    .size-info-text {
        font-size: 12px;
        color: #555;
        margin-top: 5px;
        font-style: italic;
        min-height: 18px;
    }

    .stock-msg {
        color: green;
        font-size: 13px;
        font-weight: bold;
        margin: 10px 0;
        min-height: 20px;
    }

    .add-btn {
        width: 100%;
        padding: 15px;
        background: #000;
        color: #fff;
        border: none;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
    }

    .add-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Similar Products */
    .similar-section {
        margin-top: 40px;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }

    .similar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }

    .sim-item {
        text-align: center;
        cursor: pointer;
    }

    .sim-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 6px;
    }

    .sim-item p {
        font-size: 11px;
        margin-top: 5px;
    }

    /* Floating Cart */
    #floatingCart {
        position: fixed;
        top: 30px;
        left: 10px;
        background: transparent;
        color: #555;
        padding: 10px;
        font-size: 22px;
        cursor: pointer;
        z-index: 99999;
        opacity: 0.7;
    }

    /* Cart Panel */
    #cartPanel {
        position: fixed;
        top: 0;
        right: -360px;
        width: 340px;
        height: 100%;
        background: #fff;
        box-shadow: -5px 0 20px rgba(0,0,0,0.2);
        transition: right 0.3s;
        z-index: 10002;
        display: flex;
        flex-direction: column;
    }

    #cartPanel.open {
        right: 0;
    }

    .cart-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .cart-header span {
        font-weight: bold;
        color: #000;
    }

    /* Scrollable Cart Body */
    .cart-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .cart-item {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }

    .qty-box {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
    }

    .qty-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .qty-btn:hover {
        background: #000;
        color: #fff;
    }

    /* Individual Remove Button Style */
    .remove-item-btn {
        background: none;
        border: none;
        color: #e74c3c;
        font-size: 12px;
        cursor: pointer;
        padding: 2px 5px;
        text-decoration: underline;
    }
    .remove-item-btn:hover {
        color: #c0392b;
    }

    .cart-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        background: #fff;
        flex-shrink: 0;
    }

    /* Order Detail & Return Form Styles */
    
    .order-card {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #eee;
        cursor: pointer;
    }
    .order-card:hover { border-color: #000; }

    .order-status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
    }
    .status-placed { background: #fff3cd; color: #856404; }
    .status-dispatched { background: #cce5ff; color: #004085; }
    .status-delivered { background: #d4edda; color: #155724; }

    .return-section {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 2px solid #000;
    }
    
    .return-section input, 
    .return-section select, 
    .return-section textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
    }

    .return-section input:read-only {
        background: #f5f5f5;
        color: #777;
    }

    /* Footer */
    footer {
        background: #000;
        color: #fff;
        padding: 40px 20px;
        text-align: center;
        margin-top: 50px;
    }

    .footer-links {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
    }

    .footer-links a {
        padding: 10px 25px;
        border-radius: 25px;
        text-decoration: none;
        color: #fff;
        font-size: 14px;
        font-weight: bold;
        width: 200px;
        text-align: center;
    }

    .social-row {
        display: flex;
        gap: 15px;
        justify-content: center;
        width: 100%;
    }

    /* Loader */
    #loaderWrap, #checkoutLoader {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 99999;
    }

    .loader-text {
        color: #fff;
        font-size: 26px;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { opacity: 0.5; transform: scale(0.95); }
        50% { opacity: 1; transform: scale(1); }
        100% { opacity: 0.5; transform: scale(0.95); }
    }

    #cartOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        z-index: 10001;
    }

    #toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #000;
        color: #fff;
        padding: 15px 25px;
        border-radius: 8px;
        opacity: 0;
        z-index: 100000;
        transition: opacity 0.3s;
        pointer-events: none;
        text-align: center;
    }

    #toast.show {
        opacity: 1;
    }

    /* Lead Capture Popup Style */
    #leadModal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 99998;
        display: none;
        align-items: center;
        justify-content: center;
    }

    /* Confirmation Timer Modal */
    #confirmModal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        z-index: 999999;
        display: none;
        align-items: center;
        justify-content: center;
    }

    /* Thank You Modal */
    #thankYouModal {
        position: fixed;
        inset: 0;
        background: #fff;
        z-index: 999999;
        display: none;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
    }

    /* Star Rating Style */
    .star-rating {
        display: flex; 
        flex-direction: row-reverse; 
        justify-content: center; 
        margin-bottom: 10px;
    }
    .star-rating input { display: none; }
    .star-rating label {
        cursor: pointer;
        font-size: 24px;
        color: #ccc;
        margin: 0 2px;
    }
    .star-rating label:before { content: '‚òÖ'; }
    .star-rating input:checked ~ label { color: #f5a623; }
    .star-rating label:hover, .star-rating label:hover ~ label { color: #f5a623; }

    /* Responsive */
    @media (max-width: 768px) {
        .products {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .card img {
            height: 280px;
        }
        #productModal .main-image-box img {
            max-height: 350px;
        }
        #cartPanel {
            width: 100%;
            right: -100%;
        }
    }

</style>
</head>
<body oncontextmenu="return false;">

<!-- Loader -->
<div id="loaderWrap">
    <div class="loader-text">AK FASHION HUB...</div>
</div>
<div id="checkoutLoader">
    <div class="loader-text">Processing...</div>
</div>

<!-- Zoom Overlay -->
<div id="zoomOverlay" onclick="closeZoom()">
    <img id="zoomImg" src="" alt="Zoom">
</div>

<!-- Floating Cart -->
<div id="floatingCart" onclick="toggleCart()">üõí</div>

<!-- Lead Capture Modal -->
<div id="leadModal">
    <div style="background:#fff; padding:25px; width:90%; max-width:350px; border-radius:10px; text-align:center">
        <h3 style="margin-bottom:10px; font-size:18px">Unlock Exclusive Offers</h3>
        <p style="font-size:13px; color:#666; margin-bottom:15px">Verify your mobile number to access exclusive member offers and receive important order updates.</p>
        <input id="leadPhone" placeholder="Enter Mobile Number" maxlength="10" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:6px; margin-bottom:10px; font-size:16px; text-align:center" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <button onclick="saveLeadNumber()" style="width:100%; padding:12px; background:#25D366; color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:16px">VERIFY NOW</button>
        <div onclick="document.getElementById('leadModal').style.display='none'" style="margin-top:10px; font-size:12px; color:#999; cursor:pointer">No thanks</div>
    </div>
</div>

<!-- Confirmation Timer Modal -->
<div id="confirmModal">
    <div style="background:#fff; padding:25px; width:90%; max-width:400px; border-radius:10px; text-align:center">
        <h3 style="margin-bottom:15px">Confirm Your Order</h3>
        <p style="font-size:14px; color:#555; margin-bottom:10px">Are you sure you want to place the order?</p>
        <div id="timerDisplay" style="font-size:24px; font-weight:bold; margin-bottom:20px; color:#e74c3c">02:00</div>
        <div style="display:flex; gap:10px; justify-content:center">
            <button onclick="confirmOrderYes()" style="padding:12px 30px; background:#25D366; color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:16px">Yes</button>
            <button onclick="confirmOrderNo()" style="padding:12px 30px; background:#e74c3c; color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:16px">No</button>
        </div>
    </div>
</div>

<!-- Thank You Modal -->
<div id="thankYouModal">
    <div>
        <h2 style="font-size:22px; margin-bottom:15px">Thank You for Shopping!</h2>
        <p style="font-size:16px; color:#555; line-height:1.6; margin-bottom:10px">
            Thank you for shopping with AK Fashion Hub.<br>
            Our team will call you shortly for order confirmation and payment details.
        </p>
        <div style="margin-top:20px; font-size:14px; color:#999">This message will close automatically...</div>
    </div>
</div>

<!-- Product Modal -->
<div id="productModal">
    <div class="top-bar">
        <h3 id="modalTitle">Product</h3>
        <span class="close-btn" onclick="closeModal()">&times;</span>
    </div>
    <div class="content">
        <div class="main-image-box">
            <img id="modalMainImg" src="" alt="Product" onclick="openZoom(this.src)">
        </div>
        
        <div class="thumbs" id="modalThumbs"></div>

        <div class="details">
            <div class="price-big" id="modalPrice"></div>
            <div class="desc" id="modalDesc"></div>
            <div class="desc" id="modalMeasure"></div>

            <div class="opt-group">
                <div class="opt-title">Select Size</div>
                <div class="opt-box" id="modalSizes"></div>
                <div id="sizeInfoDisplay" class="size-info-text"></div>
            </div>

            <div class="opt-group">
                <div class="opt-title">Select Color</div>
                <div class="opt-box" id="modalColors"></div>
            </div>

            <div class="stock-msg" id="modalStock"></div>
            
            <button id="modalAddBtn" class="add-btn" onclick="addToCartFromModal()" disabled>ADD TO CART</button>
        </div>

        <div class="similar-section">
            <h4>Similar Products</h4>
            <div class="similar-grid" id="similarGrid"></div>
        </div>
    </div>
</div>

<!-- Overlay -->
<div id="cartOverlay" onclick="toggleCart()"></div>

<!-- Header -->
<header>
    <h1>AK FASHION HUB</h1>
    <div class="tagline">PREMIUM MEN & WOMEN FASHION WEAR</div>
    <div class="address">KESHAV NAGAR, SWARG AASHRAM ROAD, HAPUR 245101</div>
</header>

<!-- Cart Panel -->
<div id="cartPanel">
    <div class="cart-header">
        <h3>Your Cart</h3>
        <span style="cursor:pointer; font-size:22px" onclick="toggleCart()">‚úñ</span>
    </div>
    
    <div class="cart-body" id="cartBodyContent">
        <div id="cartItemsView">
            <div id="cartItems"></div>

            <div id="cartTotal" style="font-size: 16px; font-weight:bold; margin:15px 0 12px 0; color:#000"></div>
            
            <input id="couponInput" placeholder="Enter Coupon Code" style="margin-bottom:5px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px" oninput="applyCoupon()">
            <small id="couponMsg" style="color:green"></small>
            
            <div id="priceBreak" style="font-size:15px; color:#333; margin:15px 0; line-height:1.8; background:#f9f9f9; padding:12px; border-radius:8px"></div>
            
            <div style="display:flex; flex-direction:column; gap:8px">
                <button id="addrBtn" onclick="openAddress()" style="background:#ccc; color:#666; padding:12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer">Add / Edit Address</button>
                
                <label style="font-size:12px; display:flex; align-items:center; gap:5px; margin:5px 0; background:none;">
                    <input type="checkbox" id="termsCheck" style="width:auto; margin:0;"> I agree to <span onclick="openTerms()" style="color:#007bff; text-decoration:underline; cursor:pointer">Terms and Condition</span>
                </label>
                
                <button onclick="checkout()" style="background:#000; color:#fff; padding:15px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:16px">PLACE YOUR ORDER</button>
                
                <button onclick="openMyOrders()" style="background:#fff; color:#000; border:1px solid #000; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; margin-top:5px">MY ORDERS</button>
            </div>
        </div>

        <div id="myOrdersView" style="display:none">
            <div id="orderInputArea">
                <input id="orderPhone" placeholder="Phone Number" maxlength="10" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:8px">
                <input id="orderOid" placeholder="Order ID" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:8px">
                <button onclick="trackOrder()" style="width:100%; padding:12px; background:#000; color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer">TRACK ORDER</button>
            </div>
            
            <div id="orderList" style="margin-top:15px"></div>
            
            <button onclick="backToCart()" style="width:100%; background:#fff; color:#000; border:1px solid #000; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer; margin-top:15px">‚Üê BACK</button>
        </div>
    </div>
</div>

<!-- Address Modal -->
<div id="addressModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; z-index:60000; align-items:center; justify-content:center">
    <div style="background:#fff; padding:20px; width:90%; max-width:400px; border-radius:10px; position:relative">
        <span onclick="closeAddress()" style="position:absolute; top:10px; left:10px; cursor:pointer; font-size:20px; font-weight:bold; color:#000;">‚ùå</span>
        <h3 style="text-align:center; margin-bottom:15px">Delivery Address</h3>
        <input id="aName" placeholder="Full Name *" style="width:100%; padding:10px; margin-bottom:8px; border:1px solid #ccc; border-radius:6px">
        <input id="aPhone" type="tel" placeholder="Mobile Number" maxlength="10" oninput="this.value=this.value.replace(/[^0-9]/g,'')" style="width:100%; padding:10px; margin-bottom:8px; border:1px solid #ccc; border-radius:6px">
        <textarea id="aAddr" rows="2" placeholder="House No., Street, Landmark, Famous Place *" style="width:100%; padding:10px; margin-bottom:8px; border:1px solid #ccc; border-radius:6px"></textarea>
        <input id="aCity" placeholder="City *" style="width:100%; padding:10px; margin-bottom:8px; border:1px solid #ccc; border-radius:6px">
        <input id="aPin" type="tel" placeholder="Pincode *" maxlength="6" oninput="this.value=this.value.replace(/[^0-9]/g,'')" style="width:100%; padding:10px; margin-bottom:8px; border:1px solid #ccc; border-radius:6px">
        <input id="aState" placeholder="State *" style="width:100%; padding:10px; margin-bottom:8px; border:1px solid #ccc; border-radius:6px">
        <button onclick="saveAddress()" style="width:100%; padding:12px; background:#000; color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer">SAVE ADDRESS</button>
    </div>
</div>

<!-- Products Container -->
<div class="container">
    <div class="filter-bar">
        <button class="filter-btn active" onclick="filterProds('All')">All</button>
        <button class="filter-btn" onclick="filterProds('Men')">Men</button>
        <button class="filter-btn" onclick="filterProds('Women')">Women</button>
    </div>
    <div class="products" id="productsGrid"></div>
</div>

<!-- Footer -->
<footer>
    <p style="cursor:pointer; text-decoration:underline; color:#4da3ff; font-size:12px;" onclick="openTerms()">TERMS AND CONDITION APPLY</p>
    
    <div class="footer-links">
        <div class="social-row">
            <a href="https://www.instagram.com/a_k_fashion_hub_/" target="_blank" title="" style="background:#E1306C">Instagram</a>
            <a href="https://wa.me/919599497909" target="_blank" title="" style="background:#25D366">HELP & SUPPORT</a>
        </div>
    </div>
</footer>

<div id="toast"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbw5TID63QkdJbJDRtRmg7ICQFOH-FUzzVU1QDvJZ7rV8gpvEsPEO43Hpek0OVWbezqZKw/exec";
const SESSION_KEY = "akfh_session";
const SESSION_DAYS = 30;
const RETURN_WINDOW_DAYS = 3;

let products = [];
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let currentProdIndex = null;
let allOrders = [];
let currentOrderDetail = null;
window.pState = {};

let siteCoupons = {};
let siteOffer = null;
let appliedCoup = null;

let confirmTimerInterval = null;
let confirmTimeLeft = 120;
let isProcessing = false;

const RETURN_REASONS = [
    "Size not fit",
    "Wrong product received",
    "Damaged product",
    "Color different from image",
    "Other issue"
];

function showToast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2500);
}

async function apiPost(data) {
  const sessionId = localStorage.getItem('akfh_session_id') || Math.random().toString(36).substring(2);
  localStorage.setItem('akfh_session_id', sessionId);
  
  const res = await fetch(API, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({...data, _sid: sessionId, _ts: Date.now()})
    });
    return JSON.parse(await res.text());
}

function getPriceInfo(variant) {
    let final = variant.price;
    let mrp = variant.mrp ? variant.mrp : Math.round(variant.price * 1.2);
    return { mrp: mrp, final: final };
}

function isReturnWindowOpen(deliveryDate) {
    if (!deliveryDate) return false;
    const delivery = new Date(deliveryDate);
    const now = new Date();
    const diffDays = Math.floor((now - delivery) / (1000 * 60 * 60 * 24));
    return diffDays <= RETURN_WINDOW_DAYS;
}

function initLeadPopup() {
    const timeLimit = 240000;
    if(localStorage.getItem("lead_verified")) return;
    
    const addr = JSON.parse(localStorage.getItem("addr"));
    if (!addr || !addr.phone) {
        setTimeout(() => {
            if(localStorage.getItem("lead_verified")) return;
            const checkAddr = JSON.parse(localStorage.getItem("addr"));
            if (!checkAddr || !checkAddr.phone) {
                document.getElementById("leadModal").style.display = "flex";
            }
        }, timeLimit);
    }
}

function saveLeadNumber() {
    const phone = document.getElementById("leadPhone").value.trim();
    if (!/^[6-9]\d{9}$/.test(phone)) { alert("Invalid number"); return; }

    const d = { phone: phone };
    localStorage.setItem("addr", JSON.stringify(d));
    localStorage.setItem("lead_verified", "true");
    apiPost({ type: "CHECKOUT_LEAD", phone: d.phone, name: "Lead User", address: "Website Popup Lead", cart: "Popup Lead", total: "0" }).catch(e=>{});
    
    document.getElementById("leadModal").style.display = "none";
    showToast("Number verified!");
}

function renderProducts() {
    const grid = document.getElementById("productsGrid");
    grid.innerHTML = "";

    products.forEach((p, i) => {
        if (!p.variants || p.variants.length === 0) return;
        
        const gender = document.querySelector(".filter-btn.active").innerText;
        if (gender !== "All" && p.gender !== gender) return;

        const img = (p.img && p.img[0]) ? p.img[0] : "";
        if(!img) return;
        
        const priceInfo = getPriceInfo(p.variants[0]);

        grid.innerHTML += `
            <div class="card" onclick="openModal(${i})">
                <img src="${img}" alt="${p.name}">
                <div class="price-overlay">
                    <span class="mrp-tag">MRP ‚Çπ${priceInfo.mrp}</span>
                    <span class="final-tag">‚Çπ${priceInfo.final}</span>
                    <div class="name-tag">${p.name}</div>
                </div>
            </div>
        `;
    });
}

function filterProds(type) {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
    renderProducts();
}

function openModal(index) {
    currentProdIndex = index;
    const p = products[index];
    
    document.getElementById("modalTitle").innerText = p.name;
    document.getElementById("modalDesc").innerText = p.description || "Premium Quality Product.";
    document.getElementById("modalMeasure").innerText = p.measure ? "Measurements: " + p.measure : "";
    
    const priceInfo = getPriceInfo(p.variants[0]);
    document.getElementById("modalPrice").innerHTML = `<span style="text-decoration:line-through; font-size:14px; color:#999">MRP ‚Çπ${priceInfo.mrp}</span> ‚Çπ${priceInfo.final}`;

    const mainImg = document.getElementById("modalMainImg");
    mainImg.src = (p.img && p.img[0]) ? p.img[0] : "";

    const thumbs = document.getElementById("modalThumbs");
    thumbs.innerHTML = "";
    if (p.img && p.img.length > 0) {
        p.img.forEach((src, i) => {
            thumbs.innerHTML += `<img src="${src}" class="thumb ${i===0?'active':''}" onclick="changeImg('${src}', this)">`;
        });
    }

    renderModalOpts(p);
    renderSimilar(p); 

    document.getElementById("productModal").style.display = "flex";
    document.body.style.overflow = "hidden";
    document.getElementById('floatingCart').style.display = 'none';
}

function openZoom(src) {
    document.getElementById("zoomOverlay").style.display = "flex";
    document.getElementById("zoomImg").src = src;
    document.getElementById('floatingCart').style.display = 'none';
}

function closeZoom() {
    document.getElementById("zoomOverlay").style.display = "none";
    const modal = document.getElementById("productModal");
    const icon = document.getElementById('floatingCart');
    const panel = document.getElementById("cartPanel");
    
    if (modal.style.display !== 'flex' && !panel.classList.contains("open")) {
        icon.style.display = 'block';
    }
}

function changeImg(src, el) {
    document.getElementById("modalMainImg").src = src;
    document.querySelectorAll(".thumb").forEach(t => t.classList.remove("active"));
    el.classList.add("active");
}

function renderModalOpts(p) {
    const state = window.pState[p.id] || {};
    const sizes = [...new Set(p.variants.filter(v => Number(v.stock) > 0).map(v => v.size))];
    const colors = state.size ? [...new Set(p.variants.filter(v => Number(v.stock) > 0 && v.size === state.size).map(v => v.color))] : [];

    let stockMsg = "";
    let canAdd = false;

    if (state.size && state.color) {
        const v = p.variants.find(v => v.size === state.size && v.color === state.color);
        if (v && Number(v.stock) > 0) {
            stockMsg = `Hurry! Only ${v.stock} left.`;
            canAdd = true;
        } else if (v && Number(v.stock) <= 0) {
            stockMsg = "Out of Stock";
            canAdd = false;
        }
    }

    document.getElementById("modalSizes").innerHTML = sizes.map(s => 
        `<div class="opt-btn ${state.size === s ? 'selected' : ''}" onclick="selOpt('size', '${s}')">${s}</div>`
    ).join("");

    document.getElementById("modalColors").innerHTML = colors.map(c => 
        `<div class="opt-btn ${state.color === c ? 'selected' : ''}" onclick="selOpt('color', '${c}')">${c}</div>`
    ).join("");

    document.getElementById("modalStock").innerText = stockMsg;
    document.getElementById("modalStock").style.color = canAdd ? "green" : "red";
    
    const sizeInfoDiv = document.getElementById("sizeInfoDisplay");
    if (state.size && p.sizeChart && p.sizeChart[state.size]) {
        sizeInfoDiv.innerText = `${state.size}: ${p.sizeChart[state.size]}`;
    } else {
        sizeInfoDiv.innerText = "";
    }

    document.getElementById("modalAddBtn").disabled = !canAdd;
}

function selOpt(type, val) {
    const p = products[currentProdIndex];
    if (!window.pState[p.id]) window.pState[p.id] = {};
    const cur = window.pState[p.id];
    
    if (type === 'size') {
        if (cur.size === val) delete cur.size;
        else cur.size = val;
        delete cur.color;
    } else {
        if (cur.color === val) delete cur.color;
        else cur.color = val;
    }
    renderModalOpts(p);
}

function renderSimilar(p) {
    const box = document.getElementById("similarGrid");
    const sims = products.filter(x => x.id !== p.id && x.gender === p.gender).slice(0, 4);
    
    box.innerHTML = sims.map(s => {
        const idx = products.findIndex(x => x.id === s.id);
        return `<div class="sim-item" onclick="openModal(${idx})"><img src="${s.img && s.img[0] ? s.img[0] : ''}"><p>${s.name}</p></div>`;
    }).join("");
}

function closeModal() {
    document.getElementById("productModal").style.display = "none";
    document.body.style.overflow = "";
    const icon = document.getElementById('floatingCart');
    const panel = document.getElementById("cartPanel");
    if (!panel.classList.contains("open")) {
        icon.style.display = 'block';
    }
}

function addToCartFromModal() {
    const p = products[currentProdIndex];
    const state = window.pState[p.id] || {};
    
    if (!state.size || !state.color) { showToast("Please select size and color"); return; }

    const v = p.variants.find(x => x.size === state.size && x.color === state.color);
    if (!v || v.stock <= 0) { showToast("Out of stock"); return; }

    let existing = cart.find(x => x.id === p.id && x.size === state.size && x.color === state.color);
    if (existing) {
        if (existing.qty < existing.maxStock) existing.qty++;
        else { showToast("Stock limit reached"); return; }
    } else {
        cart.push({
            id: p.id, name: p.name, size: state.size, color: state.color,
            qty: 1, maxStock: v.stock, price: v.price, weight: v.weight || 500
        });
    }

    localStorage.setItem("cart", JSON.stringify(cart));
    updateCart();
    showToast("Added to cart!");
}

function updateCart() {
    const box = document.getElementById("cartItems");
    box.innerHTML = "";
    let sub = 0;
    let totalWeight = 0;

    for (let i = cart.length - 1; i >= 0; i--) {
        if (!cart[i].price) { cart.splice(i, 1); continue; }
        sub += Number(cart[i].price) * cart[i].qty;
        totalWeight += (cart[i].weight || 500) * cart[i].qty;
    }

    cart.forEach((c, i) => {
        box.innerHTML += `
            <div class="cart-item">
                <div style="display:flex; justify-content:space-between; align-items:start">
                    <div style="font-weight:bold; flex:1">${c.name}</div>
                    <button class="remove-item-btn" onclick="removeItem(${i})">Remove</button>
                </div>
                <div style="font-size:12px; color:#666; margin-bottom:5px">Size: ${c.size} | Color: ${c.color}</div>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <div class="qty-box">
                        <button class="qty-btn" onclick="chgQty(${i}, -1)">‚àí</button>
                        <span>${c.qty}</span>
                        <button class="qty-btn" onclick="chgQty(${i}, 1)">+</button>
                    </div>
                    <div style="display:flex; align-items:center; gap:5px">
                         <span style="font-size:12px; color:#666">‚Çπ${c.price} √ó ${c.qty} =</span>
                         <b>‚Çπ${c.price * c.qty}</b>
                    </div>
                </div>
            </div>
        `;
    });

    if (cart.length === 0) {
        document.getElementById("cartTotal").innerHTML = "Your cart is empty";
        document.getElementById("priceBreak").innerHTML = "";
        updBadge(0);
        return;
    }

    let del = calcDel(totalWeight);
    let disc = 0;
    let msg = "";

    if (appliedCoup && siteCoupons[appliedCoup]) {
        const r = siteCoupons[appliedCoup];
        if (r.type === "FREE_DELIVERY") disc += del;
        if (r.type === "FLAT") disc += r.val;
        msg = "Coupon Applied";
    } else if (siteOffer && sub >= siteOffer.min) {
        disc = siteOffer.disc;
        msg = `‚Çπ${siteOffer.disc} OFF Applied`;
    } else {
        if(siteOffer) msg = `Add ‚Çπ${siteOffer.min - sub} more for discount`;
        else msg = "";
    }

    const total = Math.max(sub + del - disc, 0);
    
    document.getElementById("priceBreak").innerHTML = `
        Subtotal: ‚Çπ${sub}<br>
        Delivery: ‚Çπ${del}<br>
        Discount: ‚àí‚Çπ${disc}<br>
        <b style="font-size:17px">Total: ‚Çπ${total}</b>
    `;
    document.getElementById("cartTotal").innerHTML = `<span style="font-size:14px; color:green">${msg}</span>`;
    
    localStorage.setItem("cart", JSON.stringify(cart));
    updBadge(total);
    
    const addr = JSON.parse(localStorage.getItem("addr"));
    const addrBtn = document.getElementById("addrBtn");
    if (addr && addr.name && addr.phone && addr.address && addr.city && addr.state && addr.pin) {
        addrBtn.style.background = "#000";
        addrBtn.style.color = "#fff";
    } else {
        addrBtn.style.background = "#ccc";
        addrBtn.style.color = "#666";
    }
}

function calcDel(w) {
    let c = 50;
    if (w > 1801) {
        c = 160;
        let extra = w - 1801;
        let steps = Math.ceil(extra / 300);
        c += steps * 20;
    } else if (w > 1501) c = 160;
    else if (w > 1201) c = 140;
    else if (w > 901) c = 120;
    else if (w > 601) c = 90;
    else if (w > 301) c = 70;
    
    if (c > 350) c = 350;
    return c;
}

function chgQty(i, d) {
    if (d === -1) { cart[i].qty--; if (cart[i].qty <= 0) cart.splice(i, 1); }
    if (d === 1 && cart[i].qty < cart[i].maxStock) cart[i].qty++;
    updateCart();
}

function removeItem(index) {
    cart.splice(index, 1);
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCart();
    showToast("Item removed");
}

function applyCoupon() {
    const code = document.getElementById("couponInput").value.trim().toUpperCase();
    const msg = document.getElementById("couponMsg");
    if (siteCoupons[code]) {
        appliedCoup = code;
        msg.innerText = "‚úÖ Applied";
        msg.style.color = "green";
    } else {
        appliedCoup = null;
        msg.innerText = "Invalid";
        msg.style.color = "red";
    }
    updateCart();
}

function toggleCart() {
    const panel = document.getElementById("cartPanel");
    const over = document.getElementById("cartOverlay");
    const icon = document.getElementById("floatingCart");
    const modal = document.getElementById("productModal");
    const isOpen = panel.classList.contains("open");
    
    if (isOpen) {
        panel.classList.remove("open");
        over.style.display = "none";
        if (modal.style.display !== 'flex') {
            icon.style.display = "block";
        }
        document.body.style.overflow = "";
    } else {
        panel.classList.add("open");
        over.style.display = "block";
        icon.style.display = "none";
        backToCart();
        document.body.style.overflow = "hidden";
    }
}

function updBadge(t) {
    let b = document.getElementById("cartCount");
    
    if (cart.length === 0) {
        if (b) b.remove();
        
        let bar = document.getElementById("bb");
        if (bar) bar.style.display = "none";
        return;
    }

    if (!b) {
        b = document.createElement("span");
        b.id = "cartCount";
        b.style.cssText = "background:red; color:#fff; border-radius:50%; padding:2px 6px; font-size:12px; position:absolute; top:-5px; right:-5px";
        document.getElementById("floatingCart").appendChild(b);
    }
    b.innerText = cart.reduce((s, i) => s + i.qty, 0);
    
    let bar = document.getElementById("bb");
    if (!bar) {
        bar = document.createElement("div");
        bar.id = "bb";
        bar.style.cssText = "position:fixed; bottom:0; left:0; width:100%; background:#000; color:#fff; padding:12px; display:none; justify-content:space-between; z-index:9999";
        bar.onclick = toggleCart;
        document.body.appendChild(bar);
    }
    if (window.innerWidth < 768 && cart.length > 0) {
        bar.style.display = "flex";
        bar.innerHTML = `üõí View Cart (${cart.length}) <b>‚Çπ${t}</b>`;
    } else {
        bar.style.display = "none";
    }
}

function genId() {
    const d = new Date();
    const randomPart = Math.random().toString(36).substring(2, 8);
    const timePart = Date.now().toString(36).slice(-6);
    return `AKFH-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}-${timePart}${randomPart}`.toUpperCase();
}

function checkout() {
    if (!cart.length) { alert("Cart empty"); return; }
    if (!document.getElementById("termsCheck").checked) { alert("Please agree to Terms and Condition"); return; }
    
    const addr = JSON.parse(localStorage.getItem("addr"));
    if (!addr || !/^[6-9]\d{9}$/.test(addr.phone) || !addr.name || !addr.address || !addr.city || !addr.state || String(addr.pin).length !== 6) {
        alert("Please fill complete address");
        return;
    }

    for (let item of cart) {
        const p = products.find(x => x.id === item.id);
        if (p) {
            const v = p.variants.find(x => x.size === item.size && x.color === item.color);
            if (!v || Number(v.stock) < item.qty) {
                alert(`${item.name} (${item.size}, ${item.color}) is out of stock or has insufficient quantity.`);
                return;
            }
        }
    }

    confirmTimeLeft = 120;
    document.getElementById("confirmModal").style.display = "flex";
    updateTimerDisplay();
    
    if (confirmTimerInterval) clearInterval(confirmTimerInterval);
    confirmTimerInterval = setInterval(() => {
        confirmTimeLeft--;
        updateTimerDisplay();
        if (confirmTimeLeft <= 0) {
            clearInterval(confirmTimerInterval);
            document.getElementById("confirmModal").style.display = "none";
            showToast("Time expired. Order cancelled.");
        }
    }, 1000);
}

function updateTimerDisplay() {
    const min = Math.floor(confirmTimeLeft / 60);
    const sec = confirmTimeLeft % 60;
    document.getElementById("timerDisplay").innerText = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

function confirmOrderNo() {
    clearInterval(confirmTimerInterval);
    document.getElementById("confirmModal").style.display = "none";
    showToast("Order cancelled.");
}

async function confirmOrderYes() {
    if (isProcessing) return;
    isProcessing = true;

    clearInterval(confirmTimerInterval);
    document.getElementById("confirmModal").style.display = "none";
    document.getElementById("checkoutLoader").style.display = "flex";

    const addr = JSON.parse(localStorage.getItem("addr"));
    const oid = genId();
    
    let sub = 0; 
    let totalWeight = 0;
    cart.forEach(c => {
        sub += Number(c.price) * c.qty;
        totalWeight += (c.weight || 500) * c.qty;
    });

    let del = calcDel(totalWeight);
    let disc = 0;
    if (appliedCoup && siteCoupons[appliedCoup]) {
        const r = siteCoupons[appliedCoup];
        if (r.type === "FREE_DELIVERY") disc += del;
        if (r.type === "FLAT") disc += r.val;
    } else if (siteOffer && sub >= siteOffer.min) {
        disc = siteOffer.disc;
    }
    
    const total = Math.max(sub + del - disc, 0);

    try {
        for (let item of cart) {
            const p = products.find(x => x.id === item.id);
            if (p) {
                const v = p.variants.find(x => x.size === item.size && x.color === item.color);
                if (!v || Number(v.stock) < item.qty) {
                    throw new Error("Stock insufficient for " + item.name);
                }
            }
        }

        const res = await apiPost({
            type: "PLACE_ORDER",
            orderId: oid,
            name: addr.name,
            phone: addr.phone,
            products: cart.map(c => `${c.name}(${c.size},${c.color})x${c.qty}`).join(", "),
            items: cart,
            totalQty: cart.reduce((s, i) => s + i.qty, 0),
            productsPrice: sub,
            deliveryCharge: del,
            totalAmount: total,
            address: `${addr.address}, ${addr.city}, ${addr.state} - ${addr.pin}`
        });

        document.getElementById("checkoutLoader").style.display = "none";

        if (res.status !== "SUCCESS") {
            alert(res.message || "Order failed. Please try again.");
            isProcessing = false;
            return;
        }

        localStorage.setItem(SESSION_KEY, JSON.stringify({ phone: addr.phone, lastOid: oid, time: Date.now() }));
        
        cart = [];
        localStorage.removeItem("cart");
        updateCart();
        toggleCart();
        
        document.getElementById("thankYouModal").style.display = "flex";
        setTimeout(() => {
            document.getElementById("thankYouModal").style.display = "none";
        }, 10000);

        loadProds();

    } catch(e) {
        document.getElementById("checkoutLoader").style.display = "none";
        alert(e.message || "Connection error. Please try again.");
    }
    isProcessing = false;
}

function openAddress() {
    document.getElementById("addressModal").style.display = "flex";
    const s = JSON.parse(localStorage.getItem("addr"));
    if (s) {
        document.getElementById("aName").value = s.name || "";
        document.getElementById("aPhone").value = "";
        document.getElementById("aAddr").value = s.address || "";
        document.getElementById("aCity").value = s.city || "";
        document.getElementById("aPin").value = s.pin || "";
        document.getElementById("aState").value = s.state || "";
    } else {
        document.getElementById("aName").value = "";
        document.getElementById("aPhone").value = "";
        document.getElementById("aAddr").value = "";
        document.getElementById("aCity").value = "";
        document.getElementById("aPin").value = "";
        document.getElementById("aState").value = "";
    }
}
function closeAddress() { document.getElementById("addressModal").style.display = "none"; }
function saveAddress() {
    const d = {
        name: aName.value.trim(), phone: aPhone.value.trim(),
        address: aAddr.value.trim(), city: aCity.value.trim(),
        pin: aPin.value.trim(), state: aState.value.trim()
    };
    if (!d.name) { alert("Enter Full Name"); return; }
    if (!/^[6-9]\d{9}$/.test(d.phone)) { alert("Enter valid 10-digit Indian Mobile Number"); return; }
    if (!d.address) { alert("Enter Complete Address"); return; }
    if (!d.city) { alert("Enter City"); return; }
    if (!/^[1-9][0-9]{5}$/.test(d.pin)) { alert("Enter valid 6-digit Pincode"); return; }
    if (!d.state) { alert("Enter State"); return; }
    
    const oldAddr = JSON.parse(localStorage.getItem("addr"));
    if (!oldAddr || oldAddr.phone !== d.phone) {
         apiPost({ type: "CHECKOUT_LEAD", phone: d.phone, name: d.name, address: `${d.address}, ${d.city}`, cart: "Lead", total: "Lead" }).catch(e=>{});
    }

    localStorage.setItem("addr", JSON.stringify(d));
    closeAddress();
    updateCart();
    alert("Address Saved!");
}

function openMyOrders() {
    document.getElementById("cartItemsView").style.display = "none";
    document.getElementById("myOrdersView").style.display = "block";
    
    const sess = JSON.parse(localStorage.getItem(SESSION_KEY));
    
    if (sess && sess.phone && sess.lastOid && (Date.now() - sess.time < SESSION_DAYS * 24 * 60 * 60 * 1000)) {
        document.getElementById("orderInputArea").style.display = "none";
        fetchOrders(sess.phone, sess.lastOid);
    } else {
        localStorage.removeItem(SESSION_KEY);
        document.getElementById("orderInputArea").style.display = "block";
        document.getElementById("orderList").innerHTML = "";
    }
}

async function fetchOrders(phone, oid) {
    document.getElementById("checkoutLoader").style.display = "flex";
    try {
        let url = API + "?phone=" + phone;
        if(oid) url += "&orderId=" + oid;
        
        const res = await fetch(url);
        const d = JSON.parse(await res.text());
        document.getElementById("checkoutLoader").style.display = "none";
        if (d.status === "SUCCESS" && d.orders && d.orders.length) {
            allOrders = d.orders;
            renderOrders(d.orders);
        } else {
            document.getElementById("orderList").innerHTML = `<p style='text-align:center; color:#666; padding:20px'>${d.message || 'No orders found'}</p>`;
        }
    } catch(e) {
        document.getElementById("checkoutLoader").style.display = "none";
        document.getElementById("orderList").innerHTML = "<p style='text-align:center; color:red'>Error loading orders</p>";
    }
}

function renderOrders(list) {
    document.getElementById("orderList").innerHTML = list.map((o, idx) => {
        const statusClass = o.status === 'Delivered' ? 'status-delivered' : 
                           o.status === 'Dispatched' ? 'status-dispatched' : 'status-placed';
        
        const placedDate = o.date ? new Date(o.date).toLocaleDateString() : 'N/A';
        const deliveryDate = o.deliveryDate ? new Date(o.deliveryDate).toLocaleDateString() : '';

        return `
            <div class="order-card" onclick="showOrderDetail(${idx})">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                    <b style="font-size:13px">${o.orderId}</b>
                    <span style="font-size:11px; color:#666">${placedDate}</span>
                </div>
                <div style="font-size:12px; display:flex; justify-content:space-between; align-items:center">
                    <span class="order-status-badge ${statusClass}">${o.status || 'Placed'}</span>
                    <b>‚Çπ${o.total || o.totalAmount}</b>
                </div>
                ${deliveryDate ? `<div style="font-size:11px; color:#888; margin-top:5px">Delivered: ${deliveryDate}</div>` : ''}
            </div>
        `;
    }).join("");
}

function showOrderDetail(idx) {
    const o = allOrders[idx];
    currentOrderDetail = o;
    
    const statusClass = o.status === 'Delivered' ? 'status-delivered' : 
                       o.status === 'Dispatched' ? 'status-dispatched' : 'status-placed';
    
    const isDelivered = o.status === 'Delivered';
    const returnOpen = isDelivered && isReturnWindowOpen(o.deliveryDate);

    const placedDate = o.date ? new Date(o.date).toLocaleDateString() : 'N/A';
    const deliveryDate = o.deliveryDate ? new Date(o.deliveryDate).toLocaleDateString() : '';
    
    let itemsHTML = '';
    if (o.items && Array.isArray(o.items)) {
        itemsHTML = o.items.map(item => `
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f0f0f0; font-size:13px">
                <span>${item.name} (${item.size}, ${item.color}) x${item.qty}</span>
                <span>‚Çπ${item.price * item.qty}</span>
            </div>
        `).join("");
    } else if (o.products) {
        itemsHTML = `<div style="padding:8px 0; font-size:13px">${o.products}</div>`;
    }
    
    let returnSectionHTML = '';
    if (isDelivered) {
        if (returnOpen) {
            const sess = JSON.parse(localStorage.getItem(SESSION_KEY)) || {};
            returnSectionHTML = `
                <div class="return-section">
                    <h4 style="margin-bottom:10px">Return / Replacement Request</h4>
                    <input type="text" id="retPhone" value="${sess.phone || ''}" placeholder="Mobile Number *" maxlength="10" ${sess.phone ? 'readonly' : ''}>
                    <input type="text" id="retOrderId" value="${o.orderId}" readonly>
                    <select id="retReason">
                        <option value="">Select Reason for Return *</option>
                        ${RETURN_REASONS.map(r => `<option value="${r}">${r}</option>`).join("")}
                    </select>
                    <textarea id="retNote" placeholder="Additional note (optional)"></textarea>
                    <button onclick="submitReturnRequest()" style="width:100%; padding:12px; background:#000; color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer">SUBMIT RETURN REQUEST</button>
                </div>
            `;
        } else {
            returnSectionHTML = `
                <div style="margin-top:15px; padding:10px; background:#f8d7da; color:#721c24; border-radius:6px; text-align:center; font-size:13px">
                    Return window closed (3 days after delivery)
                </div>
            `;
        }
    }

    let reviewHTML = '';
    if (isDelivered) {
        if (o.reviewSubmitted) {
            reviewHTML = `
                <div style="margin-top:20px; padding-top:15px; border-top:1px solid #eee">
                    <h4 style="margin-bottom:10px; font-size:14px">Your Rating</h4>
                    <div style="font-size:20px; color:#f5a623">${'‚òÖ'.repeat(o.reviewRating || 0)}${'‚òÜ'.repeat(5 - (o.reviewRating || 0))}</div>
                    <p style="font-size:12px; color:#666; margin-top:5px">${o.reviewComment || 'No comment'}</p>
                </div>
            `;
        } else {
            reviewHTML = `
                <div style="margin-top:20px; padding-top:15px; border-top:1px solid #eee">
                    <h4 style="margin-bottom:10px; font-size:14px">Rate This Product</h4>
                    <div class="star-rating">
                        <input type="radio" id="star5" name="rating" value="5" onclick="setRating(5)"><label for="star5"></label>
                        <input type="radio" id="star4" name="rating" value="4" onclick="setRating(4)"><label for="star4"></label>
                        <input type="radio" id="star3" name="rating" value="3" onclick="setRating(3)"><label for="star3"></label>
                        <input type="radio" id="star2" name="rating" value="2" onclick="setRating(2)"><label for="star2"></label>
                        <input type="radio" id="star1" name="rating" value="1" onclick="setRating(1)"><label for="star1"></label>
                    </div>
                    <textarea id="reviewComment" placeholder="Write your review here..." style="width:100%; height:80px; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:12px"></textarea>
                    <button onclick="submitReview()" style="width:100%; padding:10px; background:#000; color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer; margin-top:5px">SUBMIT REVIEW</button>
                </div>
            `;
        }
    }
    
    let similarHTML = '';
    if (products.length > 0) {
        const sims = products.slice(0, 4);
        similarHTML = `
            <div style="margin-top:20px; padding-top:15px; border-top:1px solid #eee">
                <h4 style="margin-bottom:10px; font-size:14px">Similar Products</h4>
                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px">
                    ${sims.map(s => {
                        const sidx = products.findIndex(x => x.id === s.id);
                        const img = (s.img && s.img[0]) ? s.img[0] : '';
                        return `
                            <div style="text-align:center; cursor:pointer" onclick="closeModal(); openModal(${sidx})">
                                <img src="${img}" style="width:100%; height:50px; object-fit:cover; border-radius:4px">
                                <p style="font-size:9px; margin-top:3px">${s.name}</p>
                            </div>
                        `;
                    }).join("")}
                </div>
            </div>
        `;
    }
    
    document.getElementById("orderList").innerHTML = `
        <div style="background:#f9f9f9; padding:12px; border-radius:8px; margin-bottom:10px">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <span class="order-status-badge ${statusClass}">${o.status || 'Placed'}</span>
            </div>
            <div style="font-size:12px; color:#666">Order ID: <b style="color:#000">${o.orderId}</b></div>
            <div style="font-size:12px; color:#666">Placed on: ${placedDate}</div>
            ${deliveryDate ? `<div style="font-size:12px; color:#666">Delivered on: ${deliveryDate}</div>` : ''}
        </div>
        
        <div style="background:#f9f9f9; padding:12px; border-radius:8px; margin-bottom:10px; font-size:12px">
            <div style="color:#666; margin-bottom:3px">Delivery Address</div>
            <div>${o.address || 'N/A'}</div>
        </div>
        
        <div style="margin-bottom:10px">
            <div style="font-size:11px; color:#666; margin-bottom:5px">Items</div>
            ${itemsHTML}
        </div>
        
        <div style="background:#f0f0f0; padding:12px; border-radius:8px">
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:3px">
                <span>Subtotal:</span><span>‚Çπ${o.productsPrice || 0}</span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:3px">
                <span>Delivery:</span><span>‚Çπ${o.deliveryCharge || 0}</span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:bold; margin-top:5px; padding-top:5px; border-top:1px solid #ddd">
                <span>Total:</span><span>‚Çπ${o.total || o.totalAmount}</span>
            </div>
        </div>
        
        ${reviewHTML}
        ${returnSectionHTML}
        ${similarHTML}
        
        <button onclick="renderOrders(allOrders)" style="width:100%; background:#fff; color:#000; border:1px solid #000; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer; margin-top:15px">‚Üê BACK TO ORDERS</button>
    `;
}

let currentRating = 0;
function setRating(r) {
    currentRating = r;
}

async function submitReview() {
    if (isProcessing) return;
    if (currentRating === 0) {
        showToast("Please select a star rating");
        return;
    }
    const comment = document.getElementById("reviewComment").value.trim();
    
    isProcessing = true;
    document.getElementById("checkoutLoader").style.display = "flex";
    try {
        const res = await apiPost({
            type: "SUBMIT_REVIEW",
            orderId: currentOrderDetail.orderId,
            rating: currentRating,
            comment: comment
        });
        document.getElementById("checkoutLoader").style.display = "none";
        
        if (res.status === "SUCCESS") {
            currentOrderDetail.reviewSubmitted = true;
            currentOrderDetail.reviewRating = currentRating;
            currentOrderDetail.reviewComment = comment;
            showOrderDetail(allOrders.indexOf(currentOrderDetail));
            showToast("Review submitted successfully!");
        } else {
            showToast(res.message || "Failed to submit review");
        }
    } catch(e) {
        document.getElementById("checkoutLoader").style.display = "none";
        showToast("Error submitting review");
    }
    isProcessing = false;
}

async function submitReturnRequest() {
    if (isProcessing) return;
    const phone = document.getElementById("retPhone").value.trim();
    const orderId = document.getElementById("retOrderId").value.trim();
    const reason = document.getElementById("retReason").value;
    const note = document.getElementById("retNote").value.trim();
    
    if (!/^[6-9]\d{9}$/.test(phone)) { showToast("Invalid phone"); return; }
    if (!reason) { showToast("Select reason"); return; }
    
    isProcessing = true;
    document.getElementById("checkoutLoader").style.display = "flex";
    
    try {
        const res = await apiPost({
            type: "RETURN_REQUEST",
            orderId: orderId,
            phone: phone,
            reason: reason,
            note: note,
            requestDate: new Date().toISOString(),
            status: "Requested"
        });
        
        document.getElementById("checkoutLoader").style.display = "none";
        
        if (res.status === "SUCCESS") {
            showToast("AK Fashion Hub team will call you shortly.");
            renderOrders(allOrders);
        } else {
            showToast(res.message || "Failed");
        }
    } catch(e) {
        document.getElementById("checkoutLoader").style.display = "none";
        showToast("Error");
    }
    isProcessing = false;
}

async function trackOrder() {
    const phone = orderPhone.value.trim();
    const oid = orderOid.value.trim();
    if (!/^[6-9]\d{9}$/.test(phone) || !oid) { alert("Invalid details"); return; }
    
    document.getElementById("checkoutLoader").style.display = "flex";
    try {
        const res = await fetch(API + `?phone=${phone}&orderId=${oid}`);
        const d = JSON.parse(await res.text());
        document.getElementById("checkoutLoader").style.display = "none";
        if (d.status === "SUCCESS") {
            localStorage.setItem(SESSION_KEY, JSON.stringify({ phone: phone, lastOid: oid, time: Date.now() }));
            document.getElementById("orderInputArea").style.display = "none";
            fetchOrders(phone, oid);
        } else {
            alert(d.message || "Order not found");
        }
    } catch(e) {
        document.getElementById("checkoutLoader").style.display = "none";
        alert("Error");
    }
}

function backToCart() {
    document.getElementById("myOrdersView").style.display = "none";
    document.getElementById("cartItemsView").style.display = "block";
}

async function loadProds() {
    document.getElementById("loaderWrap").style.display = "flex";
    try {
        const res = await fetch(API + "?t=" + Date.now(), { cache: "no-store" });
        const data = JSON.parse(await res.text());
        
        if (Array.isArray(data)) {
            products = data;
        } else {
            products = data.products || [];
            if (data.coupons) {
                siteCoupons = data.coupons;
            }
            if (data.offer) {
                siteOffer = data.offer;
            }
        }
        
        renderProducts();
    } catch(e) {
        document.getElementById("loaderWrap").innerHTML = "<div class='loader-text' style='cursor:pointer' onclick='location.reload()'>Error. Tap to Refresh</div>";
    }
    document.getElementById("loaderWrap").style.display = "none";
}

function openTerms() {
    let d = document.createElement("div");
    d.style.cssText = "position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:999999; display:flex; align-items:center; justify-content:center; padding:20px";
    d.innerHTML = `
        <div style="background:#fff; padding:25px; max-width:500px; border-radius:10px; max-height:80vh; overflow-y:auto; width:100%">
            <h3 style="margin-bottom:15px; text-align:center">Terms & Conditions ‚Äì AK FASHION HUB</h3>
            <div style="font-size:13px; line-height:1.8; color:#333">
                <b>‚Ä¢ Delivery Time:</b> Orders will be delivered within 4‚Äì6 working days after the order is confirmed. Delivery timelines may vary depending on location, courier partner, and operational conditions.<br><br>
                <b>‚Ä¢ Cancellation & Refund (Before Dispatch):</b> Orders cancelled within 12 hours of placing the order are eligible for a full refund. The refund amount will be processed and credited within 2‚Äì3 working days after cancellation confirmation.<br><br>
                <b>‚Ä¢ Cancellation Policy (After Dispatch):</b> Once the order has been dispatched, cancellation will not be allowed. In such cases, the customer is required to make full payment for the order.<br><br>
                <b>‚Ä¢ Product Images Disclaimer:</b> All product images displayed on this website are captured using professional camera equipment or generated/enhanced using AI technology. Due to variations in screen resolution, lighting conditions, camera settings, and pixel density, there may be slight differences in color, texture, or appearance between the images shown and the actual product received.<br><br>
                <b>‚Ä¢ Return & Replacement Request:</b> Any return or replacement request must be raised within 3 days from the date of product delivery.<br><br>
                <b>‚Ä¢ Mandatory Proof:</b> A clear unboxing video along with clear photos of the received product is mandatory for all return or replacement requests. Requests without proper video and photo proof will not be accepted under any circumstances.<br><br>
                <b>‚Ä¢ Product Condition:</b> The product must be unused, unwashed, undamaged, and in original condition. Products that are worn, washed, dirty, altered, or damaged will not be eligible for return or replacement.<br><br>
                <b>‚Ä¢ Invoice Requirement:</b> The original invoice/bill provided with the product must be submitted at the time of return or replacement. Requests without the original invoice will not be processed.<br><br>
                <b>‚Ä¢ Refund Eligibility:</b> Refunds will be issued only in cases where an incorrect or damaged product has been delivered by AK FASHION HUB.<br><br>
                <b>‚Ä¢ Size & Fit Issues:</b> In case of size or fitting issues, only replacement will be provided. Refunds are not applicable for size or fitting concerns.<br><br>
                <b>‚Ä¢ Shipping Charges:</b> For size or fitting replacements, the customer is required to pay one-side delivery/shipping charges.<br><br>
                <b>‚Ä¢ Color Variation Disclaimer:</b> Minor color differences may occur due to screen brightness, display settings, and lighting conditions. Such variations shall not be considered a defect.<br><br>
                <b>‚Ä¢ Agreement:</b> By placing an order, the customer confirms that they have read, understood, and agreed to all the above Terms & Conditions.
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="margin-top:20px; width:100%; padding:12px; background:#000; color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer">OK, I AGREE</button>
        </div>
    `;
    d.onclick = (e) => { if(e.target === d) d.remove(); };
    document.body.appendChild(d);
}

updateCart();
loadProds();
initLeadPopup();

</script>
</body>
</html>
