<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AK FASHION HUB</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style> 
    
* {
  box-sizing: border-box;
  max-width: 100%;
}

html, body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  width: 100%;
}

html, body, header {
  margin: 0 !important;
  padding: 0;
  border: 0 !important;
  outline: 0 !important;
  box-shadow: none !important;
}

    #cartPanel{
  position:fixed;
  top:0;
  right:-360px;
  width:340px;
  height:100%;
  background:#fff;
  padding:20px;
  box-shadow:-4px 0 10px rgba(0,0,0,0.3);
  transition:0.3s;
  z-index:10002;
  overflow:auto;
}

body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f4f4f4;
    color:#333;
}
header{
    background: linear-gradient(135deg, #000000, #1a1a1a);
    color:#fff;
    padding:28px 20px 24px;
    text-align:center;
    position:relative;
   
}

header h1{
    margin:0;
    font-size:38px;      
    letter-spacing:3px; 
    font-weight:800;    
}


header .tagline{
    margin:8px 0 4px;
    font-size:13px;
    letter-spacing:1.2px;
    font-weight:500;
    opacity:0.85;
}

header .address{
    margin-top:6px;
    font-size:10px;     
    letter-spacing:0.6px;
    opacity:0.6;
}


.container{
    max-width:1200px;
    margin:auto;
    padding:20px;
}
.products{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:18px;
}
.card{
    background:#fff;
    border-radius:8px;
    padding:15px;
    box-shadow:0 4px 8px rgba(0,0,0,0.1);
}
.card img{
    width:100%;
    height:320px;
    object-fit:contain;
    border-radius:6px;
    background:#f7f7f7;
}
.slider{
    position:relative;
}
.slider button{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    background:rgba(0,0,0,0.5);
    color:#fff;
    border:none;
    padding:5px;
    cursor:pointer;
}
    .single-img button{
  display: none;
}

    .slider {
  width: 100%;
  height: auto;
  overflow: hidden;
}

.product-img {
  width: 100%;
  max-height: 500px;
  object-fit: contain;
  display: block;
}
.slider .prev{
    left:0;
}
.slider .next{
    right:0;
}
select, input, textarea, button{
    width:100%;
    padding:8px;
    margin-top:6px;
}
button{
    background:#000;
    color:#fff;
    border:none;
    cursor:pointer;
}
    /* ===== Premium Quantity Buttons (Cart) ===== */

.qty-box{
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin-top:4px;
}

.qty-btn{
  width:28px;
  height:28px;
  border-radius:50%;
  border:1px solid #ccc;
  background:#fff;
  color:#000;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.2s ease;
}

.qty-btn:hover{
  background:#000;
  color:#fff;
  border-color:#000;
}

.qty-count{
  min-width:20px;
  text-align:center;
  font-size:14px;
  font-weight:600;
}
/* ===== Bonus Premium Shadow ===== */
.qty-btn{
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

button:disabled{
    background:gray;
}

footer{
    background:#000;
    color:#fff;
    text-align:center;
    padding:15px;
    margin-top:40px;
    width:100vw;
    margin-left:0;
    margin-right:0;
    padding-left:0;
    padding-right:0;
    padding-bottom:120px; 

}
    .card h3{
    font-size:16px;
    margin:6px 0;
}

.card p{
    font-size:13px;
    margin:4px 0;
}
  
#toast{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #000;
  color: #fff;
  padding: 12px 18px;
  border-radius: 6px;
  font-size: 14px;
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 10000;
}

#toast.show{
  opacity: 1;
}

#cartOverlay{
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.3);
  z-index:10001;
  display:none;
}

@media (max-width: 768px){

  header h1{
    font-size: 24px;
    letter-spacing: 1px;
  }

  header .tagline{
    font-size: 11px;
  }

  header .address{
    font-size: 9px;
    line-height: 1.4;
  }

  .container{
    padding: 12px;
  }

  .products{
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .card{
    padding: 10px;
  }

  .card img,
  .product-img{
    width: 100%;
    aspect-ratio: 3 / 4;
    height: auto;
    object-fit: contain;
    background: #f7f7f7;
  }

  .card h3{
    font-size: 14px;
  }

  .card p{
    font-size: 12px;
  }

  button, select{
    font-size: 13px;
    padding: 8px;
  }

  #cartPanel{
    width: 100%;
    right: -100%;
  }

  #floatingCart{
    top: 14px;
    left: 14px;
    padding: 9px 11px;
    font-size: 18px;
  }
}


    #floatingCart{
  position: fixed;
  top: 18px;
  left: 18px;
  background: transparent;
  color: #000;
  padding: 10px 12px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  z-index: 10050;
  box-shadow: none;
}



.address-box .row{
  display:flex;
  gap:6px;
}

.address-box .row input{
  width:50%;
}
/* ===== PRODUCT LOADER ===== */
#loaderWrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:40px 10px;
}

.loader{
  width:42px;
  height:42px;
  border:4px solid #ddd;
  border-top:4px solid #000;
  border-radius:50%;
  animation:spin 0.9s linear infinite;
  margin-bottom:12px;
}

@keyframes spin{
  to{ transform:rotate(360deg); }
}

.loader-text{
  font-size:15px;
  font-weight:600;
  color:#444;
  animation:pulse 1.4s ease-in-out infinite;
}

@keyframes pulse{
  0%,100%{ opacity:0.4; }
  50%{ opacity:1; }
}

/* ===== LOAD ERROR ===== */
#errorBox{
  display:none;
  text-align:center;
  padding:30px 10px;
  animation:shake 0.4s ease;
}

@keyframes shake{
  0%{ transform:translateX(0); }
  25%{ transform:translateX(-6px); }
  50%{ transform:translateX(6px); }
  75%{ transform:translateX(-6px); }
  100%{ transform:translateX(0); }
}

#errorBox .icon{
  font-size:26px;
  margin-bottom:8px;
}

#errorBox .msg{
  font-size:15px;
  font-weight:600;
  color:#c0392b;
}

#errorBox .hint{
  margin-top:6px;
  font-size:13px;
  color:#555;
}
/* ===== FULL SCREEN LOADER ===== */
#loaderWrap,
#errorBox{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(6px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.loaderCard{
  background:#fff;
  padding:20px;
  border-radius:14px;
  text-align:center;
  width:200px;
  box-shadow:0 10px 40px rgba(0,0,0,0.35);
  animation: popIn 0.4s ease;
}

.loaderCard h3{
  margin:0 0 15px 0;
  font-size:16px;
  letter-spacing:1px;
}

.loaderCard p{
  display:none;
}

.ring{
  width:40px;
  height:40px;
  border-radius:50%;
  border:3px solid #ddd;
  border-top:3px solid #000;
  margin:auto;
  animation: spin 1s linear infinite;
}

#errorBox button{
  margin-top:12px;
  padding:8px 14px;
  background:#000;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

@keyframes spin{
  to{ transform: rotate(360deg); }
}

@keyframes popIn{
  from{ transform: scale(0.85); opacity:0; }
  to{ transform: scale(1); opacity:1; }
}
/* ===== FIX: Checkbox alignment & ghost focus box ===== */
#checkoutSection label{
  display:flex;
  align-items:center;
  gap:6px;
}


label input[type="checkbox"]{
  margin:0;
}

/* REMOVE GHOST / LIGHT FOCUS BOX */
button:focus,
input:focus,
textarea:focus,
select:focus{
  outline:none !important;
  box-shadow:none !important;
}

/* ===== POPUP STYLES ===== */
#discountPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 999999;
  display: none;
  align-items: center;
  justify-content: center;
}

.popup-card {
  background: #fff;
  padding: 30px;
  border-radius: 16px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 15px 40px rgba(0,0,0,0.4);
  animation: popIn 0.4s ease;
  position: relative;
}

.popup-close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 24px;
  cursor: pointer;
  color: #999;
}

.star-rating {
  font-size: 28px;
  color: #ddd;
  margin: 10px 0;
  cursor: pointer;
}
.star-rating .star.active {
  color: #ffc107;
}

</style>
    
</head>

<body>
    <!-- üîÑ PRODUCT LOADER -->
<div id="loaderWrap">
  <div class="loaderCard">
    <h3>AK FASHION HUB</h3>
    <div class="ring"></div>
  </div>
</div>

<!-- ‚ùå LOAD ERROR -->
<div id="errorBox">
  <div class="loaderCard">
    <h3>Something went wrong</h3>
    <p>Please refresh the page</p>
    <button onclick="location.reload()">‚Üª Refresh</button>
  </div>
</div>

<!-- üéÅ DISCOUNT POPUP -->
<div id="discountPopup">
  <div class="popup-card">
    <span class="popup-close" onclick="closePopup()">&times;</span>
    <h3 style="margin-bottom:10px;">üéÅ Exclusive Offer!</h3>
    <p style="font-size:14px; color:#555; margin-bottom:15px;">
      Enter your mobile number to unlock a special discount coupon.
    </p>
    <input id="popupPhone" type="tel" maxlength="10" placeholder="Enter Mobile Number" style="margin-bottom:10px;">
    <p id="popupError" style="color:red; font-size:12px; margin:0;"></p>
    <button onclick="submitPopup()" style="margin-top:10px; width:100%;">UNLOCK COUPON</button>
    <p onclick="maybeLater()" style="margin-top:15px; font-size:12px; color:#999; cursor:pointer; text-decoration:underline;">
      Maybe Later
    </p>
    <div id="couponResult" style="display:none; margin-top:15px; background:#f0fff0; padding:10px; border-radius:8px; border:1px solid #0f0;">
       <b style="color:green;">Your Coupon: SAVE100</b>
       <p style="font-size:12px; margin-top:5px;">Screenshot this & apply at checkout!</p>
       <a href="https://wa.me/919599497909?text=Hi!%20I%20got%20SAVE100%20coupon%20from%20website." target="_blank" style="background:#25D366; color:#fff; padding:8px 15px; border-radius:20px; text-decoration:none; display:inline-block; margin-top:8px; font-size:13px;">Claim on WhatsApp</a>
    </div>
  </div>
</div>

<div id="cartOverlay"></div>

    <div id="floatingCart" onclick="toggleCart()">üõí</div>
    

    <header style="position:relative;">
  <h1>AK FASHION HUB</h1>

  <div class="tagline">
    PREMIUM MEN & WOMEN FASHION WEAR
  </div>

  <div class="address">
   ADDRESS:- KESHAV NAGAR, SWARG AASHRAM ROAD, HAPUR 245101
  </div> 


        
</header>
<!-- CART PANEL -->
<div id="cartPanel">

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3>Your Cart</h3>
    <span onclick="smartClose()" style="cursor:pointer;font-size:22px;">‚úñ</span>
  </div>

  <div id="cartItems"></div>
  <h3 id="total"></h3>
   
<div id="couponBox" style="margin:12px 0;">

    <input
  id="couponInput"
  placeholder="Enter coupon code"
  style="
    width:100%;
    padding:10px;
    border:1px solid #ccc;
    border-radius:6px;
  "
  oninput="autoApplyCoupon()"
/>

<p id="couponMsg" style="font-size:13px;margin-top:6px;"></p>


</div>



<div id="priceBreakup" style="font-size:14px; margin-top:10px;"></div>

<div id="checkoutSection">

  <button onclick="openAddressModal()" style="margin-top:8px;">
    ‚ûï Add / Edit Delivery Address
  </button>

  <div style="
    background:#f9f9f9;
    padding:10px;
    border-radius:6px;
    margin-top:10px;
  ">
    <div style="font-size:14px; display:flex; align-items:center; gap:6px;">
      <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
        <input type="checkbox" id="terms">
        I agree to the
        <span
          onclick="openTerms()"
          style="color:#007bff; text-decoration:underline; cursor:pointer; white-space:nowrap;"
        >
          Terms & Conditions
        </span>
      </label>
    </div>
  </div>
  
   <button id="placeOrderBtn" onclick="checkout()" style="margin-top:10px;">
  Place Order (WhatsApp)
</button>

  </div>

  <!-- MY ORDERS -->
  <div id="myOrdersSection" style="display:none; margin-top:12px;">
    <input id="orderPhone" placeholder="Enter phone number" maxlength="10">
    <input id="orderIdCheck" placeholder="Enter Order ID">

 <button id="trackBtn" onclick="trackMyOrder()">TRACK ORDER</button>


    <div id="myOrders" style="margin-top:10px;"></div>

    <button
   onclick="
  document.getElementById('myOrdersSection').style.display='none';
  document.getElementById('myOrders').innerHTML = '';
  document.getElementById('checkoutSection').style.display='block';
  document.getElementById('cartItems').style.display='block';
  document.getElementById('total').style.display='block';
  document.getElementById('priceBreakup').style.display='block';
  document.getElementById('couponBox').style.display='block';
  document.getElementById('myOrdersBtn').style.display='block';
"
  style="
    margin-top:12px;
    background:#fff;
    color:#000;
    border:1px solid #000;
    font-weight:bold;
  "
  >
  ‚Üê BACK TO CHECKOUT
</button>
  </div>

  <button
      id="myOrdersBtn"
    onclick="openMyOrders()"
    style="
      margin-top:12px;
      background:#fff;
      color:#000;
      border:1px solid #000;
      font-weight:bold;
    "
  >
    MY ORDERS
  </button>

</div>


<div class="container" id="productSection">
    <h2>Products</h2>
    <div style="margin-bottom:20px; display:flex; gap:10px;">
  <button onclick="filterProducts('All')">All</button>
  <button onclick="filterProducts('Men')">Men</button>
  <button onclick="filterProducts('Women')">Women</button>
</div>

    <div class="products" id="products"></div>
</div>
<footer>
   <p>
  Return Policy:
  <span
    style="color:#4da3ff; cursor:pointer; text-decoration:underline;"
    onclick="openTerms()"
  >
    (Terms and Conditions Apply)
  </span>
</p>
    
 <p style="margin-bottom:10px; font-size:14px;">
  <b>Follow us on</b>
</p>

<div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">

  <a href="https://www.instagram.com/a_k_fashion_hub_/"
     target="_blank"
     style="
       background:#E1306C;
       color:#fff;
       padding:10px 18px;
       border-radius:25px;
       text-decoration:none;
       font-size:14px;
       font-weight:bold;
     ">
    Instagram
  </a>

  <a href="https://share.google/1K75n4058QJ60W7RZ"
     target="_blank"
     style="
       background:#4285F4;
       color:#fff;
       padding:10px 18px;
       border-radius:25px;
       text-decoration:none;
       font-size:14px;
       font-weight:bold;
     ">
    Google Review
  </a>

</div>

<div style="margin-top:16px; text-align:center;">

  <a href="https://wa.me/919599497909?text=Hello%20AK%20FASHION%20HUB%20%F0%9F%91%8B%0A%0AI%20need%20help%20regarding%20my%20order%20or%20products.%0A%0APlease%20assist%20me%20with%3A%0A%E2%80%A2%20Product%20details%0A%E2%80%A2%20Price%20%26%20offers%0A%E2%80%A2%20Size%20availability%0A%E2%80%A2%20Delivery%20%26%20return%20policy%0A%E2%80%A2%20Order%20status%20%2F%20support%0A%0AThank%20you%20%F0%9F%99%82"
     target="_blank"
     style="
       background:#25D366;
       color:white;
       padding:12px 22px;
       border-radius:30px;
       text-decoration:none;
       font-weight:bold;
       font-size:14px;
       display:inline-block;
       box-shadow:0 4px 10px rgba(0,0,0,0.3);
     ">
    üí¨ Help & Support
  </a>

</div>
    

     

</footer>
  <div id="addressModal"
     onclick="event.stopPropagation()"
     style="
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  z-index:60000;
  align-items:center;
  justify-content:center;
">

  <div style="
    background:#fff;
    width:90%;
    max-width:420px;
    border-radius:10px;
    padding:15px;
    position:relative;
  ">

    <span onclick="closeAddressModal()"
      style="position:absolute;top:12px;left:12px;
      font-size:20px;cursor:pointer;">‚ùå</span>

    <h3 style="text-align:center;">Delivery Address</h3>

    <input id="addr_name" placeholder="Full Name *">
    <input id="addr_phone" placeholder="Mobile Number *" maxlength="10"
oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <textarea id="addr_address" rows="2"
      placeholder="House No, Street, Area *"></textarea>

    <div style="display:flex;gap:6px;">
      <input id="addr_city" placeholder="City *">
     <input id="addr_pincode" placeholder="Pincode *" maxlength="6"
oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        
    </div>

    <input id="addr_state" placeholder="State *">

    <textarea id="addr_note" rows="2"
      placeholder="Note (optional, max 50 words)"></textarea>

    <button onclick="saveAddress()" style="margin-top:10px;">
      ‚úÖ Save Address
    </button>

  </div>
</div>

<script>

let products = [];
    const PRODUCT_CACHE_KEY = "akfh_products_cache";
const PRODUCT_CACHE_TIME = 1000 * 60 * 10; // 10 minutes

// ‚úÖ NAYA URL YAHAN PASTE KARO (STEP 3)
const PRODUCT_API = "https://script.google.com/macros/s/AKfycbyxYTgZeO78uB2XKwCDXgPNm42e9L1AqoLHP5sJtEQEI9BPZlRD7haLUBwUJiOmqZN2/exec";

   
let cart = JSON.parse(localStorage.getItem('cart')) || [];


  const AUTO_OFFER = {
  minAmount: 1499,  
  discount: 100    
};
  
let COUPONS = {
  "FREEDEL": { type: "FREE_DELIVERY" },
  "SAVE100": { type: "FLAT", value: 100 }
};


let appliedCoupon = null;


    let currentFilter = "All";

function filterProducts(type){
  currentFilter = type;
  renderProducts();
}
    function renderProducts(){
        
  const box = document.getElementById("products");
        

  box.innerHTML = "";

  products.forEach((p, i) => {
if(!p.variants || p.variants.length === 0){
  return;
}

    if(currentFilter !== "All" && p.gender !== currentFilter) return;

    // sizes & colors from variants
    const sizes = [...new Set(p.variants.map(v => v.size))];
    const colors = [...new Set(p.variants.map(v => v.color))];

    box.innerHTML += `
      <div class="card">
 <div class="slider ${p.img.length <= 1 ? 'single-img' : ''}">

  <button class="prev" onclick="changeImage(${i},-1)">‚Äπ</button>

  <img
    id="img${i}"
    src="${p.img[0] || 'https://dummyimage.com/600x800/eee/000&text=AK+FASHION+HUB'}"
    class="product-img"
    onclick="openImage(this.src)"
  >



  <button class="next" onclick="changeImage(${i},1)">‚Ä∫</button>
</div>


        <p style="font-size:12px;color:#666">${p.gender}</p>

        <h3>${p.name}</h3>
        <p>SKU: ${p.id}</p>
   <p style="font-weight:bold">
  Price: ‚Çπ${p.variants[0].price}
</p>

 

        <p>${p.category}</p>
        <p style="font-size:12px">${p.description}</p>
        <p style="font-size:12px"><b>Measurements:</b> ${p.measure}</p>

        <select id="size${i}" onchange="updateStockMsg(${i})">
          <option value="">Select Size</option>
          ${sizes.map(s => `<option>${s}</option>`).join("")}
        </select>

        <select id="color${i}" onchange="updateStockMsg(${i})">
          <option value="">Select Color</option>
          ${colors.map(c => `<option>${c}</option>`).join("")}
        </select>

        <p id="stockMsg${i}" style="font-size:12px;font-weight:bold;"></p>

        <button id="btn${i}" onclick="addToCart(${i})" disabled>
          Add to Cart
        </button>
      </div>
    `;
  });
}

async function loadProductsFromSheet(){

const loader = document.getElementById("loaderWrap");
const errorBox = document.getElementById("errorBox");
loader.style.display = "flex";


  loader.style.display = "flex";

  // üîπ STEP A ‚Äî CACHE CHECK
  const cached = localStorage.getItem(PRODUCT_CACHE_KEY);

  if(cached){
    try{
      const parsed = JSON.parse(cached);

      // cache valid hai?
      if(Date.now() - parsed.time < PRODUCT_CACHE_TIME){
        products = parsed.data;
        loader.style.display = "none";
        renderProducts();

        // üîÑ background refresh
        fetchFreshProducts(false);
        return;
      }
    }catch(e){
      // ignore broken cache
    }
  }

  // üîπ STEP B ‚Äî NORMAL LOAD
  fetchFreshProducts(true);
}


async function fetchFreshProducts(showLoader){

  const loader = document.getElementById("loaderWrap");
  const error = document.getElementById("errorBox");

  if(showLoader){
    loader.style.display = "flex";
  }


  try{
    const res = await fetch(PRODUCT_API, { cache:"no-store" });
    if(!res.ok) throw new Error("Network");

    const data = await res.json();
    if(!Array.isArray(data) || data.length === 0){
      throw new Error("Empty");
    }

    const freshProducts = data.map(p => ({
      id: p.id,
      name: p.id,
      gender: p.gender,
      category: p.category,
      measure: p.measure,
      description: p.description,
      img: p.img,
      variants: p.variants
    }));

    // üîê SAVE TO CACHE
    localStorage.setItem(
      PRODUCT_CACHE_KEY,
      JSON.stringify({
        time: Date.now(),
        data: freshProducts
      })
    );

    products = freshProducts;
    loader.style.display = "none";
    renderProducts();

  }catch(err){
     loader.style.display = "none";
errorBox.style.display = "flex";
    console.error("Fresh load failed", err);

    if(!products || products.length === 0){
      loader.style.display = "none";
      
    }
  }
}

function updateStockMsg(i){
  const size = document.getElementById("size"+i).value;
  const color = document.getElementById("color"+i).value;
  const msg = document.getElementById("stockMsg"+i);
  const btn = document.getElementById("btn"+i);

  btn.disabled = true;
  msg.innerText = "";

  if(!size || !color) return;

  const p = products[i];

  const variant = p.variants.find(v =>
    String(v.size).trim() === String(size).trim() &&
    String(v.color).toLowerCase().trim() === String(color).toLowerCase().trim()
  );

  if(variant && Number(variant.stock) > 0){
    msg.innerText = `Only ${variant.stock} left`;
    msg.style.color = "green";
    btn.disabled = false;   // üî• THIS IS IMPORTANT
  }else{
    msg.innerText = "Out of stock";
    msg.style.color = "red";
    btn.disabled = true;
  }
}


function changeImage(i, dir){
  const p = products[i];
  if(!p || !p.img || p.img.length <= 1) return;

  const imgEl = document.getElementById("img"+i);
  let current = p.img.findIndex(src => imgEl.src.includes(src));
  if(current === -1) current = 0;

  current = (current + dir + p.img.length) % p.img.length;
  imgEl.src = p.img[current];
}


function showToast(message){
  const toast = document.getElementById("toast");
  toast.innerText = message;
  toast.classList.add("show");

  setTimeout(()=>{
    toast.classList.remove("show");
  },2000);
}
let imageModal = null;

function openImage(src){
  if(!imageModal){
    imageModal = document.createElement("div");
    imageModal.style.position = "fixed";
    imageModal.style.top = "0";
    imageModal.style.left = "0";
    imageModal.style.width = "100%";
    imageModal.style.height = "100%";
    imageModal.style.background = "rgba(0,0,0,0.9)";
    imageModal.style.zIndex = "99999";
    imageModal.style.display = "flex";
    imageModal.style.alignItems = "center";
    imageModal.style.justifyContent = "center";

    imageModal.innerHTML = `
      <img id="zoomImg" style="max-width:95%; max-height:95%;">
    `;

    imageModal.onclick = () => imageModal.style.display = "none";
    document.body.appendChild(imageModal);
  }

  document.getElementById("zoomImg").src = src;
  imageModal.style.display = "flex";
}

function addToCart(i){
  const size = document.getElementById("size"+i).value;
  const color = document.getElementById("color"+i).value;

  if(!size || !color){
    showToast("Select size & color");
    return;
  }

  const p = products[i];

  const variant = p.variants.find(v =>
    String(v.size) === String(size) &&
    String(v.color).toLowerCase() === String(color).toLowerCase()
  );

  if(!variant || variant.stock <= 0){
    showToast("Out of stock");
    return;
  }

  let existing = cart.find(
    item => item.id === p.id && item.size === size && item.color === color
  );

  if(existing){
    if(existing.qty < existing.maxStock){
      existing.qty++;
    }else{
      showToast("Stock limit reached");
      return;
    }
  }else{
    cart.push({
      id: p.id,
      name: p.name,
      size,
      color,
      qty: 1,
      maxStock: variant.stock,
      price: variant.price,
      weight: variant.weight || 500
    });
  }

  localStorage.setItem("cart", JSON.stringify(cart));
  updateCart();
  showToast("Item added to cart");
}

function updateCart(){

  let subtotal = 0;
  const box = document.getElementById("cartItems");
  box.innerHTML = "";

  // üîπ LOOP 1 ‚Äî SUBTOTAL + SAFETY
  for(let i = cart.length - 1; i >= 0; i--){
    const c = cart[i];

    if(!c.price || isNaN(c.price)){
      showToast("Price error, item removed");
      cart.splice(i, 1);
      continue;
    }

    subtotal += Number(c.price) * c.qty;
  }

  // üîπ LOOP 2 ‚Äî CART UI
  cart.forEach((c, index) => {
    box.innerHTML += `
      <div style="border-bottom:1px solid #ddd;padding:10px 0;">
        <b>${c.name}</b><br>
        Size: ${c.size} | Color: ${c.color}<br>
        <p style="margin:4px 0; font-size:13px;">
          Price: ‚Çπ${c.price} √ó ${c.qty} = <b>‚Çπ${Number(c.price) * c.qty}</b>
        </p>

        Qty:
        <div class="qty-box">
          <button class="qty-btn" onclick="changeQty(${index},-1)">‚àí</button>
          <span class="qty-count">${c.qty}</span>
          <button class="qty-btn" onclick="changeQty(${index},1)">+</button>
        </div>

        <button onclick="askRemove(${index})"
          style="margin-top:6px;background:#eee;color:#000;">
          Remove
        </button>
      </div>
    `;
  });

  if(cart.length === 0){
    document.getElementById("total").innerHTML = "Your cart is empty";
    document.getElementById("priceBreakup").innerText = "";
    updateCartBadge();
    updateBottomBar(0);
    return;
  }

  const totalWeight = calculateTotalWeight();
  let delivery = calculateDeliveryCharge(totalWeight, subtotal);

  let discount = 0;
  let offerMsg = "";

  if(appliedCoupon){
    const rule = COUPONS[appliedCoupon];
    if(rule){
      if(rule.type === "FREE_DELIVERY") delivery = 0;
      if(rule.type === "FLAT") discount += rule.value;
      offerMsg = `Coupon ${appliedCoupon} applied`;
    }else{
      appliedCoupon = null;
    }
  }else{
    if(subtotal >= AUTO_OFFER.minAmount){
      discount += AUTO_OFFER.discount;
      offerMsg = `üéâ ‚Çπ${AUTO_OFFER.discount} OFF applied`;
    }else{
      offerMsg = `Add ‚Çπ${AUTO_OFFER.minAmount - subtotal} more to get ‚Çπ${AUTO_OFFER.discount} OFF`;
    }
  }

  const finalTotal = Math.max(subtotal + delivery - discount, 0);

document.getElementById("priceBreakup").innerText =
  offerMsg + (appliedCoupon ? " üéüÔ∏è" : "");

  document.getElementById("total").innerHTML = `
    <div>Subtotal: ‚Çπ${subtotal}</div>
    <div>Delivery: ‚Çπ${delivery}</div>
    <div>Discount: ‚àí‚Çπ${discount}</div>
    <hr>
    <b>Total Payable: ‚Çπ${finalTotal}</b>
  `;

  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartBadge();
  updateBottomBar(finalTotal);
}




    
    function calculateTotalWeight(){
  let totalWeight = 0;

  cart.forEach(item => {
    const itemWeight = item.weight || 500; 
    totalWeight += itemWeight * item.qty;
  });

  return totalWeight; 
}
function calculateDeliveryCharge(weight, orderValue){

  if(weight <= 0) return 0;
  if(weight > 5000) return 200;

  // üîπ 50g slab = ‚Çπ7
  const roundedWeight = Math.ceil(weight / 50) * 50;
  const baseDelivery = (roundedWeight / 50) * 7;

  let delivery = baseDelivery;

  // üîπ Order value based discount
  if(orderValue >= 1200){
    delivery -= 70;
  }
  else if(orderValue >= 999){
    delivery -= 50;
  }
  else{
    // üîπ First 500g NO discount
    const extraWeight = Math.max(0, weight - 500);
    const weightDiscount = Math.floor(extraWeight / 500) * 35;
    delivery -= weightDiscount;
  }

  // üîí Minimum delivery ‚Çπ70
  delivery = Math.max(70, delivery);
// üîê LOSS PROTECTION
delivery = Math.ceil(delivery / 5) * 5; // round to nearest 5
// üîê EXTRA SAFETY FOR HEAVY ORDERS
delivery = Math.max(delivery, 70 + Math.floor(weight / 1000) * 10);

  return delivery;
}


    function changeQty(index, diff){
  const item = cart[index];

 
  if(diff === -1){
    item.qty--;
    if(item.qty <= 0){
      cart.splice(index,1);
    }
  }

  
  if(diff === 1){
  if(item.qty < item.maxStock){
    item.qty++;
  }else{
    showToast("Maximum stock limit reached");
    return;
  }
}


  localStorage.setItem("cart", JSON.stringify(cart));
  updateCart();
}

let removeIndex = null;

function askRemove(index){
  removeIndex = index;
  const item = cart[index];

  document.getElementById("confirmText").innerText =
    `Are you sure you want to remove "${item.name}" from cart?`;

  document.getElementById("confirmBox").style.display = "flex";
}

function confirmYes(){
  const item = cart[removeIndex];

  cart.splice(removeIndex, 1);
  localStorage.setItem("cart", JSON.stringify(cart));

  document.getElementById("confirmBox").style.display = "none";
  showToast("Item removed from cart");
updateCart();
    renderProducts();
}

function confirmNo(){
  document.getElementById("confirmBox").style.display = "none";
}

    function generateOrderId(){
  const now = new Date();
  const date =
    now.getFullYear().toString() +
    String(now.getMonth() + 1).padStart(2, "0") +
    String(now.getDate()).padStart(2, "0");

  const random = Math.floor(1000 + Math.random() * 9000);
  return `AKFH-${date}-${random}`;
}
    
async function checkout(){

  // üîí HARD STOP ‚Äî EMPTY CART
  if(!cart || cart.length === 0){
    alert("Cart is empty. Please add products first.");
    return;
  }

 if(!document.getElementById("terms").checked){
  alert("Please agree to Terms & Conditions");
  return;
}


const addr = JSON.parse(localStorage.getItem("address"));

if(
  !addr ||
  !addr.name ||
  !/^[6-9]\d{9}$/.test(addr.phone) ||
  !addr.address ||
  !addr.city ||
  !addr.state ||
  !addr.pincode ||
  String(addr.pincode).length !== 6
){
  alert("Please fill complete delivery address");
  return;
}


if(window.__checkoutInProgress){
  return;
}

  // ===== CALCULATIONS MOVED HERE (FIX) =====
  const orderId = generateOrderId();
  let subtotal = 0;
  cart.forEach(c => subtotal += Number(c.price) * c.qty);

  const totalWeight = calculateTotalWeight();
  const delivery = calculateDeliveryCharge(totalWeight, subtotal);

  let discount = 0;
  if(appliedCoupon){
    const rule = COUPONS[appliedCoupon];
    if(rule){
      if(rule.type === "FREE_DELIVERY") discount += delivery;
      if(rule.type === "FLAT") discount += rule.value;
    }
  }else{
    if(subtotal >= AUTO_OFFER.minAmount){
      discount += AUTO_OFFER.discount;
    }
  }

  const finalTotal = Math.max(subtotal + delivery - discount, 0);
 
  window.__checkoutInProgress = true;
  document.getElementById("checkoutLoader").style.display = "flex";

  try{
      const res = await fetch(PRODUCT_API, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
  orderId: orderId,
  name: addr.name,
  phone: addr.phone,
  products: cart.map(c => `${c.name} (${c.size}, ${c.color}) √ó ${c.qty}`).join(", "),
  totalQty: cart.reduce((s,i)=>s+i.qty,0),
  productsPrice: subtotal,
  deliveryCharge: delivery,
  totalAmount: finalTotal,
  address: `${addr.address}, ${addr.city}, ${addr.state} - ${addr.pincode}`
})

    });

    const result = await res.json();

   if(!result || result.status !== "SUCCESS"){
  window.__checkoutInProgress = false;
  document.getElementById("checkoutLoader").style.display = "none";
  alert("Order failed. Please try again.");
  return;
}

 }catch(e){
  window.__checkoutInProgress = false;
  document.getElementById("checkoutLoader").style.display = "none";
  alert("Server error. Please try again.");
  return;
}

  // ===== ORDER SAVE =====
localStorage.setItem("activeOrder", JSON.stringify({
  orderId: orderId,
  phone: addr.phone,
  deliveredAt: null
}));

 
  // ===== WHATSAPP =====
  let msg = `AK FASHION HUB
Order ID: ${orderId}

TOTAL: ‚Çπ${finalTotal}

Customer: ${addr.name}
Phone: ${addr.phone}
Address: ${addr.address}, ${addr.city}
`;
    
document.getElementById("checkoutLoader").style.display = "none";
window.__checkoutInProgress = false;

// ‚úÖ Open WhatsApp in new tab
window.open("https://wa.me/919599497909?text=" + encodeURIComponent(msg), '_blank');

cart = [];
localStorage.removeItem("cart");
renderProducts();
updateCart();

closeAddressModal(); // Close address panel
toggleCart(); // Close cart panel

alert("Congratulations! Order Placed Successfully.\nOrder ID: " + orderId);

}

// ===== SMART CLOSE FUNCTION (FIX FOR D) =====
function smartClose(){
  const ordersSection = document.getElementById("myOrdersSection");
  if(ordersSection.style.display === "block"){
    ordersSection.style.display = "none";
    document.getElementById("checkoutSection").style.display='block';
    document.getElementById("cartItems").style.display='block';
    document.getElementById('total').style.display='block';
    document.getElementById('priceBreakup').style.display='block';
    document.getElementById('couponBox').style.display='block';
    document.getElementById('myOrdersBtn').style.display='block';
    document.getElementById('myOrders').innerHTML = '';
  } else {
    toggleCart();
  }
}

function toggleCart(){
  const floating = document.getElementById("floatingCart");
  const cartPanel = document.getElementById("cartPanel");
  const overlay = document.getElementById("cartOverlay");

  const isOpen = cartPanel.style.right === "0px";

  if(isOpen){
    cartPanel.style.right = window.innerWidth < 768 ? "-100%" : "-360px";
    overlay.style.display = "none";
    floating.style.display = "block";
    document.body.style.overflow = "";
  }else{
    cartPanel.style.right = "0px";
    overlay.style.display = "block";
    floating.style.display = "none";
    document.body.style.overflow = "hidden";
  }
}


function autoApplyCoupon(){
  const code = document
    .getElementById("couponInput")
    .value
    .trim()
    .toUpperCase();

  const msg = document.getElementById("couponMsg");

  if(code.length < 4){
    msg.innerText = "";
    appliedCoupon = null;
    updateCart();
    return;
  }

  if(!COUPONS[code]){
    msg.innerText = "‚ùå Invalid coupon";
    msg.style.color = "red";
    appliedCoupon = null;
    updateCart();
    return;
  }

  appliedCoupon = code;
  msg.innerText = "‚úÖ Coupon applied";
  msg.style.color = "green";
  updateCart();
}

</script>


<script>
// ===== ADDRESS MODAL SCRIPT =====

function openAddressModal(){
  const modal = document.getElementById("addressModal");
  modal.style.display = "flex";
  document.body.style.overflow = "hidden";
document.documentElement.style.overflow = "hidden";

  const saved = JSON.parse(localStorage.getItem("address"));
  if(saved){
    addr_name.value = saved.name;
    addr_phone.value = saved.phone;
    addr_address.value = saved.address;
    addr_city.value = saved.city;
    addr_pincode.value = saved.pincode;
    addr_state.value = saved.state;
    addr_note.value = saved.note || "";
  }
}

function closeAddressModal(){
  document.getElementById("addressModal").style.display = "none";
document.body.style.overflow = "";
document.documentElement.style.overflow = "";

}

async function saveAddress(){
  const data = {
    name: addr_name.value.trim(),
    phone: addr_phone.value.trim(),
    address: addr_address.value.trim(),
    city: addr_city.value.trim(),
    pincode: addr_pincode.value.trim(),
    state: addr_state.value.trim(),
    note: addr_note.value.trim()
  };

  // üìû Indian mobile validation
if(!/^[6-9]\d{9}$/.test(data.phone)){
  alert("Please enter a valid Indian mobile number");
  return;
}

if(
  !data.name ||
  !data.address ||
  !data.city ||
  data.pincode.length !== 6 ||
  !data.state
){
  alert("Please fill all mandatory address fields");
  return;
}


  localStorage.setItem("address", JSON.stringify(data));
  
  // ‚úÖ SAVE TO coscart SHEET (CHECKOUT LEAD)
  fetch(PRODUCT_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      type: "CHECKOUT_LEAD",
      phone: data.phone,
      name: data.name,
      address: `${data.address}, ${data.city}, ${data.state} - ${data.pincode}`,
      cart: JSON.stringify(cart),
      total: document.getElementById("total").innerText
    })
  }).catch(e => console.log("Lead save error", e));

  closeAddressModal();
  alert("Address saved successfully");
}
</script>


    
<script>

function updateCartBadge(){
  let badge = document.getElementById("cartCount");

  if(!badge){
   const cartIcon = document.getElementById("floatingCart");
    badge = document.createElement("span");
    badge.id = "cartCount";
    badge.style.background = "red";
    badge.style.color = "white";
    badge.style.borderRadius = "50%";
    badge.style.padding = "2px 6px";
    badge.style.fontSize = "12px";
    badge.style.marginLeft = "6px";
    cartIcon.appendChild(badge);
  }

  let totalQty = 0;
cart.forEach(i => totalQty += i.qty);
badge.innerText = totalQty;

}

function updateBottomBar(total){
  let bar = document.getElementById("bottomCartBar");

  if(!bar){
    bar = document.createElement("div");
    bar.id = "bottomCartBar";
    bar.style.position = "fixed";
    bar.style.bottom = "0";
    bar.style.left = "0";
    bar.style.width = "100%";
    bar.style.background = "#000";
    bar.style.color = "#fff";
    bar.style.padding = "12px";
    bar.style.display = "none";
    bar.style.justifyContent = "space-between";
    bar.style.alignItems = "center";
    bar.style.zIndex = "9999";
    bar.onclick = toggleCart;

    document.body.appendChild(bar);
  }

  if(window.innerWidth < 768 && cart.length > 0){
    bar.style.display = "flex";
    bar.innerHTML = `üõí View Cart (${cart.reduce((s,i)=>s+i.qty,0)}) <b>‚Çπ${total}</b>`;
  }else{
    bar.style.display = "none";
  }
}




    updateCart();
loadProductsFromSheet();
updateCartBadge();
    
const active = JSON.parse(localStorage.getItem("activeOrder"));
if(active){
  orderPhone.value = active.phone;
  orderIdCheck.value = active.orderId;
}

const cartOverlay = document.getElementById("cartOverlay");
cartOverlay.onclick = toggleCart;


function openMyOrders(){
    document.getElementById("myOrders").innerHTML = "";
    document.getElementById("checkoutSection").style.display="none";
    document.getElementById("cartItems").style.display="none";
    document.getElementById("total").style.display="none";
    document.getElementById("priceBreakup").style.display="none";
    document.getElementById("couponBox").style.display="none";
    document.getElementById("myOrdersSection").style.display="block";
    document.getElementById("myOrdersBtn").style.display="none";
}

if(active && active.phone && active.orderId){
  trackMyOrder();
}

    
    </script>


        <div id="toast"></div>

<div id="confirmBox" style="
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10005;
    pointer-events:auto;
">
  <div style="
    background:#fff;
    padding:20px;
    width:90%;
    max-width:320px;
    border-radius:8px;
    text-align:center;
      pointer-events:auto;
  ">
    <p id="confirmText" style="margin-bottom:15px;font-weight:bold;"></p>
    <button onclick="confirmYes()" style="width:45%;margin-right:5%;">OK</button>
    <button onclick="confirmNo()" style="width:45%;background:#ccc;color:#000;">Cancel</button>
  </div>
</div>

<script>
window.openTerms = function(){

  document.body.style.overflow = "hidden";

  let modal = document.createElement("div");
  modal.style.position = "fixed";
  modal.style.top = "0";
  modal.style.left = "0";
  modal.style.width = "100%";
  modal.style.height = "100%";
  modal.style.background = "rgba(0,0,0,0.8)";
  modal.style.zIndex = "50000";
  modal.style.display = "flex";
  modal.style.alignItems = "center";
  modal.style.justifyContent = "center";

  modal.innerHTML = `
    <div
      id="termsBox"
      style="
        background:#fff;
        padding:20px;
        width:90%;
        max-width:520px;
        max-height:85%;
        overflow:auto;
        border-radius:8px;
      "
    >
      <h3>Terms & Conditions ‚Äì AK FASHION HUB</h3>

      <p style="font-size:14px; line-height:1.6;">

‚Ä¢ <b>Delivery Time:</b> Orders will be delivered within <b>4‚Äì6 working days</b> after the order is confirmed. Delivery timelines may vary depending on location, courier partner, and operational conditions.<br><br>

‚Ä¢ <b>Cancellation & Refund (Before Dispatch):</b> Orders cancelled within <b>12 hours</b> of placing the order are eligible for a <b>full refund</b>. The refund amount will be processed and credited within <b>2‚Äì3 working days</b> after cancellation confirmation.<br><br>

‚Ä¢ <b>Cancellation Policy (After Dispatch):</b> Once the order has been <b>dispatched</b>, cancellation will <b>not be allowed</b>. In such cases, the customer is required to make <b>full payment</b> for the order.<br><br>

‚Ä¢ <b>Product Images Disclaimer:</b> All product images displayed on this website are captured using professional camera equipment or generated/enhanced using AI technology. Due to variations in screen resolution, lighting conditions, camera settings, and pixel density, there may be slight differences in color, texture, or appearance between the images shown and the actual product received.<br><br>

‚Ä¢ <b>Return & Replacement Request:</b> Any return or replacement request must be raised within <b>3 days</b> from the date of product delivery.<br><br>

‚Ä¢ <b>Mandatory Proof:</b> A <b>clear unboxing video</b> along with <b>clear photos</b> of the received product is mandatory for all return or replacement requests. Requests without proper video and photo proof will not be accepted under any circumstances.<br><br>

‚Ä¢ <b>Product Condition:</b> The product must be <b>unused, unwashed, undamaged, and in original condition</b>. Products that are worn, washed, dirty, altered, or damaged will not be eligible for return or replacement.<br><br>

‚Ä¢ <b>Invoice Requirement:</b> The <b>original invoice/bill</b> provided with the product must be submitted at the time of return or replacement. Requests without the original invoice will not be processed.<br><br>

‚Ä¢ <b>Refund Eligibility:</b> Refunds will be issued <b>only</b> in cases where an <b>incorrect or damaged product</b> has been delivered by AK FASHION HUB.<br><br>

‚Ä¢ <b>Size & Fit Issues:</b> In case of size or fitting issues, <b>only replacement will be provided</b>. Refunds are <b>not applicable</b> for size or fitting concerns.<br><br>

‚Ä¢ <b>Shipping Charges:</b> For size or fitting replacements, the customer is required to pay <b>one-side delivery/shipping charges</b>.<br><br>

‚Ä¢ <b>Color Variation Disclaimer:</b> Minor color differences may occur due to screen brightness, display settings, and lighting conditions. Such variations shall <b>not be considered a defect</b>.<br><br>

‚Ä¢ <b>Agreement:</b> By placing an order, the customer confirms that they have <b>read, understood, and agreed</b> to all the above Terms & Conditions.

      </p>

      <div id="scrollHint"
        style="font-size:12px;text-align:center;color:#666;">
        ‚¨áÔ∏è Scroll down to enable button
      </div>

      <button
        id="agreeBtn"
        disabled
        style="
          width:100%;
          margin-top:10px;
          padding:10px;
          background:gray;
          color:#fff;
          border:none;
          cursor:not-allowed;
        "
      >
        I Agree
      </button>
    </div>
  `;

  document.body.appendChild(modal);

  const box = modal.querySelector("#termsBox");
  const btn = modal.querySelector("#agreeBtn");
  const hint = modal.querySelector("#scrollHint");

  box.addEventListener("scroll", () => {
    if (box.scrollTop + box.clientHeight >= box.scrollHeight - 20) {
      btn.disabled = false;
      btn.style.background = "#000";
      btn.style.cursor = "pointer";
      hint.style.display = "none";
    }
  });

  btn.onclick = () => {
    document.getElementById("terms").checked = true;
    modal.remove();
    document.body.style.overflow = "";
  };

  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
      document.body.style.overflow = "";
    }
  };
};
</script>
<script>

    (function(){
  const cart = document.getElementById("cartPanel");
  if(!cart) return;

  cart.addEventListener("wheel", function(e){
    e.stopPropagation();
  }, { passive:true });

  cart.addEventListener("touchmove", function(e){
    e.stopPropagation();
  }, { passive:true });
})();

</script>
<div id="checkoutLoader" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999999;
">
  <div class="loaderCard">
    <h3>Placing Order</h3>
    <div class="ring"></div>
  </div>
</div>
    <script>

async function trackMyOrder(){
    const btn = document.getElementById("trackBtn");
btn.disabled = true;

  const phone = orderPhone.value.trim();
  const orderId = orderIdCheck.value.trim();
  const box = document.getElementById("myOrders");

  if(!/^[6-9]\d{9}$/.test(phone) || !orderId){
    box.innerHTML = "";
      btn.disabled = false;
    return;
  }

  checkoutLoader.style.display = "flex";

  const res = await fetch(PRODUCT_API + `?phone=${phone}&orderId=${orderId}`);
  const data = await res.json();

  checkoutLoader.style.display = "none";

  if(data.status !== "SUCCESS"){
    box.innerHTML = "<p style='color:red;text-align:center;'>Order not found</p>";
      btn.disabled = false;
    return;
  }

  renderMyOrder(data, phone);
  btn.disabled = false;
    
}

function renderMyOrder(data, phone){
  let reviewHtml = "";
  
  // ‚úÖ REVIEW LOGIC
  if(data.reviewAllowed && data.orderStatus === "Delivered"){
    reviewHtml = `
      <div style="margin-top:15px; padding:10px; background:#f9f9f9; border-radius:8px;">
        <p style="font-weight:bold; margin-bottom:5px;">‚≠ê Rate your experience</p>
        <div class="star-rating" id="starRating">
          <span class="star" onclick="setRating(1)">‚òÖ</span>
          <span class="star" onclick="setRating(2)">‚òÖ</span>
          <span class="star" onclick="setRating(3)">‚òÖ</span>
          <span class="star" onclick="setRating(4)">‚òÖ</span>
          <span class="star" onclick="setRating(5)">‚òÖ</span>
        </div>
        <textarea id="reviewNote" placeholder="Write a note (optional)" rows="2" style="font-size:12px;"></textarea>
        <button onclick="submitReview('${data.orderId}', '${phone}')" style="margin-top:5px; font-size:12px;">Submit Review</button>
      </div>
    `;
  }

  document.getElementById("myOrders").innerHTML = `
    <b>Order ID:</b> ${data.orderId}<br>
    <b>Status:</b> ${data.orderStatus}<br>
    <b>Total:</b> ‚Çπ${data.total}<br>
    <div id="orderTimeline" style="margin-top:10px;"></div>
    ${reviewHtml}
  `;
  renderTimeline(data.orderStatus);
}

let currentRating = 0;
function setRating(r){
  currentRating = r;
  const stars = document.querySelectorAll("#starRating .star");
  stars.forEach((s, i) => {
    if(i < r) s.classList.add("active");
    else s.classList.remove("active");
  });
}

async function submitReview(orderId, phone){
  const note = document.getElementById("reviewNote").value.trim();
  
  if(currentRating === 0){
    alert("Please select a star rating");
    return;
  }

  checkoutLoader.style.display = "flex";

  try {
    const res = await fetch(PRODUCT_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: "REVIEW",
        orderId: orderId,
        phone: phone,
        stars: currentRating,
        note: note
      })
    });

    const result = await res.json();
    checkoutLoader.style.display = "none";

    if(result.status === "SUCCESS"){
      alert("Thank you for your review!");
      // Hide review form
      document.getElementById("myOrders").querySelector("div").style.display = "none";
    } else {
      alert(result.message || "Failed to submit review");
    }

  } catch(e) {
    checkoutLoader.style.display = "none";
    alert("Error submitting review");
  }
}

function renderTimeline(status){
  const steps = [
    "Order Placed",
    "Dispatched",
    "Out for Delivery",
    "Delivered"
  ];

  let html = "";
  steps.forEach(s => {
    const done = steps.indexOf(s) <= steps.indexOf(status);
    html += `
      <div style="
        margin:6px 0;
        font-weight:${done ? 'bold' : 'normal'};
        color:${done ? 'green' : '#999'};
      ">
        ${done ? "‚úîÔ∏è" : "‚è≥"} ${s}
      </div>
    `;
  });

  document.getElementById("orderTimeline").innerHTML = html;
}

// ===== POPUP LOGIC =====
(function(){
  // Check if popup was closed in last 24 hours
  const lastClosed = localStorage.getItem("popupClosedTime");
  if(lastClosed && (Date.now() - lastClosed < 24 * 60 * 60 * 1000)){
    return; // Don't show popup
  }

  // Show popup after 3 minutes (180 seconds)
  setTimeout(() => {
    document.getElementById("discountPopup").style.display = "flex";
  }, 180000); // 180000ms = 3 mins
})();

function closePopup(){
  document.getElementById("discountPopup").style.display = "none";
}

function maybeLater(){
  localStorage.setItem("popupClosedTime", Date.now());
  closePopup();
}

async function submitPopup(){
  const phone = document.getElementById("popupPhone").value.trim();
  const err = document.getElementById("popupError");

  if(!/^[6-9]\d{9}$/.test(phone)){
    err.innerText = "Please enter a valid 10-digit number";
    return;
  }

  err.innerText = "";
  
  // Save to PopupLeads
  fetch(PRODUCT_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      type: "POPUP_LEAD",
      phone: phone
    })
  }).catch(e => console.log(e));

  // Show Coupon
  document.getElementById("popupPhone").style.display = "none";
  document.querySelector("#discountPopup button").style.display = "none";
  document.querySelector("#discountPopup p[onclick]").style.display = "none";
  document.getElementById("couponResult").style.display = "block";
}

</script>

</body>
</html>
